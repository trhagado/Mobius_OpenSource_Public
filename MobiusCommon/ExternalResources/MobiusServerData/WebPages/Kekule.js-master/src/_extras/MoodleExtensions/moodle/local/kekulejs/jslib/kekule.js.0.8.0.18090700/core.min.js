Kekule.AbstractConfigs=Class.create(ObjectEx,{CLASS_NAME:"Kekule.AbstractConfigs",CONFIG_PROP_FLAG:"__$config_prop__",initialize:function($super,a){$super();if(typeof(a)=="undefined"){a=true}if(a){this.initPropDefValues()}},addConfigProp:function(e,c,b,f){var d={dataType:c};if(f){d=Object.extend(d,f)}if(typeof(b)!="undefined"){d.defaultValue=b}var a=this.defineProp(e,d);a[this.CONFIG_PROP_FLAG]=true;return a},addHashConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.HASH,a,c)},addStrConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.STRING,a,c)},addNumConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.NUM,a,c)},addIntConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.INT,a,c)},addFloatConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.FLOAT,a,c)},addBoolConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.BOOL,a,c)},initPropDefValues:function(){this.beginUpdate();try{var c=this.getAllPropList();for(var b=0,a=c.getLength();b<a;++b){var f=c.getPropInfoAt(b);var e=f.name;var d=f.defaultValue;if(typeof(d)!="undefined"){this.setPropValue(e,d)}}}finally{this.endUpdate()}},assign:function(a){a.copyPropsTo(this)},toHash:function(){var b={};var a=this.CONFIG_PROP_FLAG;this.saveObj(b,"json",{saveDefaultValues:true,propFilter:function(d,c){return d[a]}});return b}});Kekule.ConfigPresetMap=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ConfigPresetMap",initialize:function($super){$super();this.map=new Kekule.MapEx(true)},doFinalize:function($super){this.map=null;$super()},set:function(a,b){this.map.set(a,b)},get:function(a){return this.map.get(a)},getHash:function(a){var b=this.get(a);if(b){if(b.toHash){return b.toHash()}else{return b}}else{return null}},remove:function(a){this.map.remove(a)},has:function(a){return this.map.has(a)},clear:function(){this.map.clear()}});Kekule.ElementSeries={NONMETAL:"Nonmetals",METAL:"Metals",ALKALI_METAL:"Alkali Metals",ALKALI_EARTH_METAL:"Alkali Earth Metals",TRANSITION_METAL:"Transition Metals",METALLOID:"Metalloids",HALOGEN:"Halogens",NOBLE_GAS:"Noble Gases",LANTHANIDE:"Lanthanides",ACTINIDE:"Actinides"};Kekule.Element=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Element",initialize:function($super,a){$super();if(a!=Kekule.Element.UNSET_ELEMENT){var b=this.getElementInfo(a);if(b){this.setPropStoreFieldValue("symbol",b.symbol);this.setPropStoreFieldValue("atomicNumber",b.atomicNumber);this.setPropStoreFieldValue("group",b.group);this.setPropStoreFieldValue("period",b.period);this.setPropStoreFieldValue("series",b.chemicalSerie);this.setPropStoreFieldValue("naturalMass",b.naturalMass);if(b.name){this.setPropStoreFieldValue("name",b.name)}}else{Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.INVALID_CHEMELEMENT")+": "+a:"Invalid chemical element: "+a)}}else{this.setPropStoreFieldValue("symbol",Kekule.Element.UNSET_ELEMENT);this.setPropStoreFieldValue("atomicNumber",Kekule.Element.UNSET_ELEMENT)}},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING,serializable:false,setter:null});this.defineProp("atomicNumber",{dataType:DataType.INT,serializable:false,setter:null});this.defineProp("symbol",{dataType:DataType.STRING,serializable:false,setter:null});this.defineProp("group",{dataType:DataType.INT,serializable:false,setter:null});this.defineProp("period",{dataType:DataType.INT,serializable:false,setter:null});this.defineProp("series",{dataType:DataType.STRING,serializable:false,setter:null});this.defineProp("naturalMass",{dataType:DataType.FLOAT,serializable:false,setter:null})},getElementInfo:function(a){if(a==Kekule.Element.UNSET_ELEMENT){return{symbol:Kekule.Element.UNSET_ELEMENT,atomicNumber:Kekule.Element.UNSET_ELEMENT}}if(Kekule.Element.isDummyElement(a)){return{symbol:Kekule.Element.DUMMY_ELEMENT,atomicNumber:Kekule.Element.DUMMY_ELEMENT_ATOMICNUM}}else{if(Kekule.Element.isRGroup(a)){return{symbol:Kekule.Element.RGROUP_ELEMENT,atomicNumber:Kekule.Element.RGROUP_ELEMENT_ATMOICNUM}}else{return Kekule.ChemicalElementsDataUtil.getElementInfo(a)}}},getTheoreticValence:function(){if(this.getGroup()){return Kekule.Element.getTheoreticValenceOfGroup(this.getGroup())}else{return null}},isDummyElement:function(){return this.getAtomicNumber()==Kekule.Element.DUMMY_ELEMENT_ATOMICNUM},isRGroupElement:function(){return this.getAtomicNumber()==Kekule.Element.RGROUP_ELEMENT_ATMOICNUM},isNormalElement:function(){return Kekule.Element.isNormalElement(this.getAtomicNumber())},isSameElement:function(a){if(a==Kekule.Element.UNSET_ELEMENT){return this.getAtomicNumber()==Kekule.Element.UNSET_ELEMENT}else{if(typeof(a)=="number"){return this.getAtomicNumber()==a}else{return this.getSymbol()==a}}},isHetero:function(){return((this.getSeries()===Kekule.ElementSeries.NONMETAL)||(this.getSeries()===Kekule.ElementSeries.HALOGEN))&&(this.getAtomicNumber()!==6)&&(this.getAtomicNumber()!==1)},getLabel:function(){return this.getSymbol()}});Object.extend(Kekule.Element,Kekule.ChemicalElementsDataUtil);Kekule.Element.UNSET_ELEMENT=undefined;Kekule.Element.DUMMY_ELEMENT="DU";Kekule.Element.DUMMY_ELEMENT_ATOMICNUM=-1;Kekule.Element.RGROUP_ELEMENT="R";Kekule.Element.RGROUP_ELEMENT_ATOMICNUM=-2;Kekule.Element.DEUTERIUM="D";Kekule.Element.isNormalElement=function(a){return(a!=Kekule.Element.UNSET_ELEMENT)&&(!Kekule.Element.isPseudoElement(a))};Kekule.Element.isPseudoElement=function(a){if(typeof(a)=="string"){return(a==Kekule.Element.DUMMY_ELEMENT)||(a==Kekule.Element.RGROUP_ELEMENT)}else{return(a==Kekule.Element.DUMMY_ELEMENT_ATOMICNUM)||(a==Kekule.Element.RGROUP_ELEMENT_ATMOICNUM)}};Kekule.Element.isDummyElement=function(a){return(a===Kekule.Element.DUMMY_ELEMENT)||(a===Kekule.Element.DUMMY_ELEMENT_ATOMICNUM)};Kekule.Element.isRGroup=function(a){return(a===Kekule.Element.RGROUP_ELEMENT)||(a===Kekule.Element.RGROUP_ELEMENT_ATOMICNUM)};Kekule.Element.getTheoreticValenceOfGroup=function(a){if(a<=2){return a}else{if(a<=12){return null}else{if(a<=17){return a-10}else{return 0}}}};Kekule.Element.getTheoreticValence=function(a){var b=Kekule.ChemicalElementsDataUtil.getElementInfo(a);return b.group?Kekule.Element.getTheoreticValenceOfGroup(b.group):null};Object.extend(Kekule.Element,{isAtomicNumberAvailable:function(a){return Kekule.ChemicalElementsDataUtil.isAtomicNumberAvailable(a)},isElementSymbolAvailable:function(a){return Kekule.ChemicalElementsDataUtil.isElementSymbolAvailable(a)}});Kekule.Isotope=Class.create(Kekule.Element,{CLASS_NAME:"Kekule.Isotope",initialize:function($super,a,b){var f=a;var e=b;var d=Kekule.IsotopesDataUtil.getIsotopeInfo(a,b);if(d){if(d.atomicNumber){f=d.atomicNumber}e=d.massNumber}$super(f);this.setPropStoreFieldValue("massNumber",e);if(d&&d.isotopeAlias){this.setPropStoreFieldValue("isotopeAlias",d.isotopeAlias)}if(Kekule.Element.isNormalElement(f)&&(e!==Kekule.Isotope.UNSET_MASSNUMBER)){var c=Kekule.IsotopesDataUtil.getIsotopeInfo(this.getAtomicNumber(),e);if(c){this.setPropStoreFieldValue("exactMass",c.exactMass);this.setPropStoreFieldValue("naturalAbundance",c.naturalAbundance)}else{Kekule.chemError((Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.INVALID_ISOTOPE"):"Invalid isotope")+": "+this.getSymbol()+"/"+b)}}},initProperties:function(){this.defineProp("massNumber",{dataType:DataType.INTEGER,serializable:false,setter:null});this.defineProp("exactMass",{dataType:DataType.FLOAT,serializable:false,setter:null});this.defineProp("naturalAbundance",{dataType:DataType.FLOAT,serializable:false,setter:null});this.defineProp("isotopeAlias",{dataType:DataType.STRING,serializable:false,setter:null})},isSame:function(a){if(a instanceof Kekule.Isotope){return(a===this)||((a.getAtomicNumber()==this.getAtomicNumber())&&(a.getMassNumber()==this.getMassNumber()))}return false},getIsotopeId:function(){return Kekule.IsotopesDataUtil.getIsotopeId(this.getAtomicNumber(),this.getMassNumber())},getLabel:function(){return""+(this.getMassNumber()||"")+this.getSymbol()}});Object.extend(Kekule.Isotope,Kekule.IsotopesDataUtil);Kekule.Isotope.UNSET_MASSNUMBER=undefined;Kekule.Isotope.getIsotopeId=function(a,b){return Kekule.IsotopesDataUtil.getIsotopeId(a,b)};Object.extend(Kekule.Isotope,{isMassNumberAvailable:function(a,b){return Kekule.IsotopesDataUtil.isMassNumberAvailable(a,b)}});Kekule.IsotopeFactory={GENERIC_ELEMENT_ID:"__GENERIC__",_isotopes:{},getIsotopeId:function(a,b){if(!a){return Kekule.IsotopeFactory.GENERIC_ELEMENT_ID}else{return Kekule.IsotopesDataUtil.getIsotopeId(a,b)}},getIsotope:function(a,b){var d=Kekule.IsotopeFactory.getIsotopeId(a,b);if(!Kekule.IsotopeFactory._isotopes[d]){var c=new Kekule.Isotope(a,b);Kekule.IsotopeFactory._isotopes[d]=c}return Kekule.IsotopeFactory._isotopes[d]},getIsotopeById:function(b){if(Kekule.IsotopeFactory._isotopes[b]){return Kekule.IsotopeFactory._isotopes[b]}else{var a=Kekule.IsotopesDataUtil.getIsotopeIdDetail(b);if(a){return Kekule.IsotopeFactory.getIsotope(a.symbol,a.massNumber)}else{return null}}}};Kekule.AtomType={UNSET_ATOMTYPE:undefined};Kekule.ElectronSet=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ElectronSet",initialize:function($super,a){$super();this.setElectronCount(a||Kekule.ElectronSet.UNSET_ELECTRONCOUNT)},initProperties:function(){this.defineProp("electronCount",{dataType:DataType.FLOAT})}});Kekule.ElectronSet.UNSET_ELECTRONCOUNT=null;Kekule.UnbondedElectronSet=Class.create(Kekule.ElectronSet,{CLASS_NAME:"Kekule.UnBondedElectronSet",initialize:function($super,a){$super(a)},initProperties:function(){}});Kekule.BondType={COVALENT:"covalent",IONIC:"ionic",COORDINATE:"coordinate",METALLIC:"metallic",HYDROGEN:"hydrogen",UNKNOWN:null,DEFAULT:"covalent"};Kekule.BondOrder={SINGLE:1,DOUBLE:2,TRIPLE:3,QUAD:4,EXPLICIT_AROMATIC:10,OTHER:20,UNSET:null,DEFAULT:1,getBondValence:function(a){if(a===Kekule.BondOrder.UNSET){return 0}else{if(a==Kekule.BondOrder.EXPLICIT_AROMATIC){return 1.5}else{return a}}}};Kekule.BondForm=Class.create(Kekule.ElectronSet,{CLASS_NAME:"Kekule.BondForm",initialize:function($super,b,c,a){$super(c);this.setBondOrder(b||Kekule.BondOrder.DEFAULT);if(Kekule.ObjUtils.notUnset(a)){this.setBondType(a)}if(Kekule.ObjUtils.notUnset(c)){this.setElectronCount(c)}},initProperties:function(){this.defineProp("bondType",{dataType:DataType.STRING,enumSource:Kekule.BondType,getter:function(){var a=this.getPropStoreFieldValue("bondType");return(a?a:Kekule.BondType.DEFAULT)}});this.defineProp("bondOrder",{dataType:DataType.FLOAT,enumSource:Kekule.BondOrder,setter:function(a){if(this.getPropStoreFieldValue("bondOrder")!=a){this.setPropStoreFieldValue("bondOrder",a);if(a){if(this.getBondType()==Kekule.BondType.COVALENT){this.setElectronCount(this.getBondValence()*2)}}else{if(a===Kekule.BondOrder.UNSET){this.setElectronCount(Kekule.ElectronSet.UNSET_ELECTRONCOUNT)}}}}});this.defineProp("electronCount",{dataType:DataType.FLOAT});this.defineProp("bondValence",{dataType:DataType.FLOAT,serializable:false,getter:function(){return Kekule.BondOrder.getBondValence(this.getBondOrder())},setter:null})}});Kekule.BondFormFactory={_bondForms:{},getBondFormId:function(c,d,b){var a="";if(b){a+=b+"_"}if(c){a+=Number(c).toString()}if(d){a+="_"+Number(d).toString()}return a},getBondForm:function(b,d,a){if((!b)&&(!d)&&(!a)){return undefined}if(!a){a=Kekule.BondType.DEFAULT}if((!d)&&(b)&&(a===Kekule.BondType.COVALENT)){var c=Kekule.BondOrder.getBondValence(b);d=c*2}var e=Kekule.BondFormFactory.getBondFormId(b,d,a);if(!Kekule.BondFormFactory._bondForms[e]){Kekule.BondFormFactory._bondForms[e]=new Kekule.BondForm(b,d,a)}return Kekule.BondFormFactory._bondForms[e]}};Kekule.RadicalOrder={NONE:0,SINGLET:1,DOUBLET:2,TRIPLET:3,DEFAULT:0,getRadicalElectronCount:function(a){var b=Kekule.RadicalOrder;if(Kekule.ObjUtils.isUnset(a)||(a===b.NONE)){return 0}else{if(a===b.DOUBLET){return 1}else{return 2}}}};Kekule.HybridizationType={UNKNOWN:null,SP:1,SP2:2,SP3:3,NONE:0};Kekule.ValenceUtils={getImplicitMdlValence:function(a,b,e){var c=b;var d=e;switch(a){case 1:case 3:case 11:case 19:case 37:case 55:case 87:if(c==0&&d<=1){return 1}break;case 4:case 12:case 20:case 38:case 56:case 88:switch(c){case 0:if(d<=2){return 2}break;case 1:if(d<=1){return 1}break}break;case 5:switch(c){case -4:if(d<=1){return 1}break;case -3:if(d<=2){return 2}break;case -2:if(d<=3){return 3}if(d<=5){return 5}break;case -1:if(d<=4){return 4}break;case 0:if(d<=3){return 3}break;case 1:if(d<=2){return 2}break;case 2:if(d<=1){return 1}break}break;case 6:switch(c){case -3:if(d<=1){return 1}break;case -2:if(d<=2){return 2}break;case -1:if(d<=3){return 3}if(d<=5){return 5}break;case 0:if(d<=4){return 4}break;case 1:if(d<=3){return 3}break;case 2:if(d<=2){return 2}break;case 3:if(d<=1){return 1}break}break;case 7:switch(c){case -2:if(d<=1){return 1}break;case -1:if(d<=2){return 2}break;case 0:if(d<=3){return 3}if(d<=5){return 5}break;case 1:if(d<=4){return 4}break;case 2:if(d<=3){return 3}break;case 3:if(d<=2){return 2}break;case 4:if(d<=1){return 1}break}break;case 8:switch(c){case -1:if(d<=1){return 1}break;case 0:if(d<=2){return 2}break;case 1:if(d<=3){return 3}if(d<=5){return 5}break;case 2:if(d<=4){return 4}break;case 3:if(d<=3){return 3}break;case 4:if(d<=2){return 2}break;case 5:if(d<=1){return 1}break}break;case 9:switch(c){case 0:if(d<=1){return 1}break;case 1:if(d<=2){return 2}break;case 2:if(d<=3){return 3}if(d<=5){return 5}break;case 3:if(d<=4){return 4}break;case 4:if(d<=3){return 3}break;case 5:if(d<=2){return 2}break;case 6:if(d<=1){return 1}break}break;case 13:switch(c){case -4:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -3:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -2:if(d<=3){return 3}if(d<=5){return 5}break;case -1:if(d<=4){return 4}break;case 0:if(d<=3){return 3}break;case 1:if(d<=2){return 2}break;case 2:if(d<=1){return 1}break}break;case 14:switch(c){case -3:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -2:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -1:if(d<=3){return 3}if(d<=5){return 5}break;case 0:if(d<=4){return 4}break;case 1:if(d<=3){return 3}break;case 2:if(d<=2){return 2}break;case 3:if(d<=1){return 1}break}break;case 15:switch(c){case -2:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 0:if(d<=3){return 3}if(d<=5){return 5}break;case 1:if(d<=4){return 4}break;case 2:if(d<=3){return 3}break;case 3:if(d<=2){return 2}break;case 4:if(d<=1){return 1}break}break;case 16:switch(c){case -1:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 0:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 1:if(d<=3){return 3}if(d<=5){return 5}break;case 2:if(d<=4){return 4}break;case 3:if(d<=3){return 3}break;case 4:if(d<=2){return 2}break;case 5:if(d<=1){return 1}break}break;case 17:switch(c){case 0:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 2:if(d<=3){return 3}if(d<=5){return 5}break;case 3:if(d<=4){return 4}break;case 4:if(d<=3){return 3}break;case 5:if(d<=2){return 2}break;case 6:if(d<=1){return 1}break}break;case 31:switch(c){case -4:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -3:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -2:if(d<=3){return 3}if(d<=5){return 5}break;case -1:if(d<=4){return 4}break;case 0:if(d<=3){return 3}break;case 2:if(d<=1){return 1}break}break;case 32:switch(c){case -3:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -2:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -1:if(d<=3){return 3}if(d<=5){return 5}break;case 0:if(d<=4){return 4}break;case 1:if(d<=3){return 3}break;case 3:if(d<=1){return 1}break}break;case 33:switch(c){case -2:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 0:if(d<=3){return 3}if(d<=5){return 5}break;case 1:if(d<=4){return 4}break;case 2:if(d<=3){return 3}break;case 4:if(d<=1){return 1}break}break;case 34:switch(c){case -1:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 0:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 1:if(d<=3){return 3}if(d<=5){return 5}break;case 2:if(d<=4){return 4}break;case 3:if(d<=3){return 3}break;case 5:if(d<=1){return 1}break}break;case 35:switch(c){case 0:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 2:if(d<=3){return 3}if(d<=5){return 5}break;case 3:if(d<=4){return 4}break;case 4:if(d<=3){return 3}break;case 6:if(d<=1){return 1}break}break;case 49:switch(c){case -4:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -3:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -2:if(d<=3){return 3}if(d<=5){return 5}break;case -1:if(d<=2){return 2}if(d<=4){return 4}break;case 0:if(d<=3){return 3}break;case 2:if(d<=1){return 1}break}break;case 50:case 82:switch(c){case -3:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -2:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -1:if(d<=3){return 3}if(d<=5){return 5}break;case 0:if(d<=2){return 2}if(d<=4){return 4}break;case 1:if(d<=3){return 3}break;case 3:if(d<=1){return 1}break}break;case 51:case 83:switch(c){case -2:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 0:if(d<=3){return 3}if(d<=5){return 5}break;case 1:if(d<=2){return 2}if(d<=4){return 4}break;case 2:if(d<=3){return 3}break;case 4:if(d<=1){return 1}break}break;case 52:case 84:switch(c){case -1:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 0:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 1:if(d<=3){return 3}if(d<=5){return 5}break;case 2:if(d<=2){return 2}if(d<=4){return 4}break;case 3:if(d<=3){return 3}break;case 5:if(d<=1){return 1}break}break;case 53:case 85:switch(c){case 0:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 2:if(d<=3){return 3}if(d<=5){return 5}break;case 3:if(d<=2){return 2}if(d<=4){return 4}break;case 4:if(d<=3){return 3}break;case 6:if(d<=1){return 1}break}break;case 81:switch(c){case -4:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -3:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -2:if(d<=3){return 3}if(d<=5){return 5}break;case -1:if(d<=2){return 2}if(d<=4){return 4}break;case 0:if(d<=1){return 1}if(d<=3){return 3}break}break}return d},getImplicitHydValence:function(a,c,g){var d=a;var e=c;var f=g;var b=0;if(d==6){b=4-abs(e)}else{if(d==7||d==15){b=3+e}else{if(d==8||d==16){b=2+e}}}if(b<0){b=0}if(f>b){b=f}return b}};Kekule.ValenceUtils.getImplicitValence=Kekule.ValenceUtils.getImplicitMdlValence;(function(){var a=Kekule.ArrayUtils;Kekule.StructureComparationLevel={SKELETAL:1,CONSTITUTION:2,CONFIGURATION:3,EXACT:4,DEFAULT:4};Kekule.globalOptions.add("algorithm.structureComparation",{structureComparationLevel:Kekule.StructureComparationLevel.DEFAULT});Kekule.globalOptions.add("algorithm.structureClean",{structureCleanOptions:{orphanChemNode:true,hangingChemConnector:true}});Kekule.ObjComparer.compareStructure=function(e,d,b){var c=Object.create(b||{});c.method=Kekule.ComparisonMethod.CHEM_STRUCTURE;return Kekule.ObjComparer.compare(e,d,c)};Kekule.ObjComparer.equalStructure=function(d,c,b){return Kekule.ObjComparer.compareStructure(d,c,b)===0};Kekule.ObjComparer.getStructureComparisonDetailOptions=function(f){var n=Object.extend({},f);if(f){var e=Kekule.StructureComparationLevel;var c=f.structureLevel||f.level||Kekule.globalOptions.algorithm.structureComparation.structureComparationLevel;var h=["atom","mass","linkedConnectorCount","charge","radical","stereo","hydrogenCount","connectedObjCount","bondType","bondOrder"];var k;if(c===e.SKELETAL){k={atom:false,mass:false,linkedConnectorCount:true,charge:false,radical:false,stereo:false,hydrogenCount:false,connectedObjCount:true,bondType:false,bondOrder:false}}else{if(c===e.CONSTITUTION){k={atom:true,mass:false,linkedConnectorCount:true,charge:false,radical:false,stereo:false,hydrogenCount:true,connectedObjCount:true,bondType:true,bondOrder:true}}else{if(c===e.CONFIGURATION){k={atom:true,mass:false,linkedConnectorCount:true,charge:false,radical:false,stereo:true,hydrogenCount:true,connectedObjCount:true,bondType:true,bondOrder:true}}else{if(c===e.EXACT){k={atom:true,mass:true,linkedConnectorCount:true,charge:true,radical:true,stereo:true,hydrogenCount:true,connectedObjCount:true,bondType:true,bondOrder:true}}}}}for(var g=0,d=h.length;g<d;++g){var m=h[g];var j="compare"+m.capitalizeFirst();var b=n[m];if(Kekule.ObjUtils.isUnset(b)){b=n[j]}if(Kekule.ObjUtils.isUnset(b)){n[m]=k[m];n[j]=k[m]}else{n[m]=b;n[j]=b}}}return n};Kekule.ChemStructureObject=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ChemStructureObject",initProperties:function(){this.defineProp("linkedConnectors",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null});this.defineProp("linkedObjs",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){var b=[];for(var g=0,d=this.getLinkedConnectorCount();g<d;++g){var c=this.getLinkedConnectorAt(g);var m=c.getConnectedObjs();for(var f=0,e=m.length;f<e;++f){var h=m[f];if(h!==this&&!(this.hasChildObj&&this.hasChildObj(h))){Kekule.ArrayUtils.pushUnique(b,m[f])}}}return b}});this.defineProp("linkedSiblings",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){var n=[];var m=this.getParent();for(var g=0,b=this.getLinkedConnectorCount();g<b;++g){var c=this.getLinkedConnectorAt(g);var h=c.getConnectedObjs();for(var e=0,d=h.length;e<d;++e){var f=h[e];if(f!==this){if(n.indexOf(f)<0){if(f.getParent()!==m){f=m.getDirectChildOfNestedNode(f)}if(f){n.push(f)}}}}}return n}})},initPropValues:function($super){$super();this.setPropStoreFieldValue("linkedConnectors",[]);this.setSuppressChildChangeEventInUpdating(true)},getAutoIdPrefix:function(){return"o"},doGetActualCompareOptions:function($super,c){if(c&&c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){var b=Kekule.ObjComparer.getStructureComparisonDetailOptions(c);if(c.customMethod){b.customMethod=c.customMethod}if(c.extraComparisonProperties){b.extraComparisonProperties=c.extraComparisonProperties}return b}else{return $super(c)}},_getComparisonOptionFlagValue:function(c,e){var d="compare"+e.capitalizeFirst();var b=c[d];if(Kekule.ObjUtils.isUnset(b)){b=c[e]}return b},doGetComparisonPropNames:function($super,b){if(b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){return[]}else{return $super(b)}},doCompare:function($super,e,c){var b=$super(e,c);if(!b&&c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(c,"linkedConnectorCount")){var f=this.getLinkedNonHydrogenConnectors();var d=e.getLinkedNonHydrogenConnectors&&e.getLinkedNonHydrogenConnectors();b=this.doCompareOnValue(f.length,d&&d.length,c)}}return b},compareStructure:function(c,b){var d=Object.create(b||{});d.method=Kekule.ComparisonMethod.CHEM_STRUCTURE;return this.compare(c,d)},equalStructure:function(c,b){return this.compareStructure(c,b)===0},getParentFragment:function(){var b=this.getParent();return(b instanceof Kekule.StructureFragment)?b:null},getRootFragment:function(){var b=this.getParentFragment();if(b){return b.getRootFragment()||b}else{return b}},notifyLinkedConnectorsChanged:function(){this.notifyPropSet("linkedConnectors",this.getPropStoreFieldValue("linkedConnectors"))},getCurrConnectableObj:function(){return this},getLinkedConnectorCount:function(){return this.getLinkedConnectors().length},getLinkedConnectorAt:function(b){return this.getLinkedConnectors()[b]},indexOfLinkedConnector:function(b){return this.getLinkedConnectors().indexOf(b)},appendLinkedConnector:function(c){var b=this._doAppendLinkedConnector(c);if(c){c._doAppendConnectedObj(this)}return b},_doAppendLinkedConnector:function(b){if(!b){return -1}var d=this.getPropStoreFieldValue("linkedConnectors");var c=Kekule.ArrayUtils.pushUniqueEx(d,b);if(c.isPushed){this.notifyLinkedConnectorsChanged()}return c.index},removeLinkedConnectorAt:function(c){var b=this.getLinkedConnectorAt(c);if(b){b._doRemoveConnectedObjAt(b.indexOfConnectedObj(this))}return this._doRemoveLinkedConnectorAt(c)},_doRemoveLinkedConnectorAt:function(b){var c=Kekule.ArrayUtils.removeAt(this.getLinkedConnectors(),b);if(c){this.notifyLinkedConnectorsChanged()}return c},removeLinkedConnector:function(b){var c=this.getLinkedConnectors().indexOf(b);if(c>=0){this.removeLinkedConnectorAt(c)}},getConnectorTo:function(e){for(var d=0,b=this.getLinkedConnectorCount();d<b;++d){var f=this.getLinkedConnectorAt(d);if(f.hasConnectedObj(e)){return f}}return null},removeThisFromLinkedConnector:function(){for(var b=this.getLinkedConnectorCount()-1;b>=0;--b){var d=this.getLinkedConnectorAt(b);d.removeConnectedObj(this)}},getLinkedObjsOnConnector:function(c){var b=[];var f=c.getConnectedObjs();for(var e=0,d=f.length;e<d;++e){if(f[e]!==this){Kekule.ArrayUtils.pushUnique(b,f[e])}}return b},getLinkedNonHydrogenConnectors:function(){var b=[];for(var e=0,d=this.getLinkedConnectorCount();e<d;++e){var c=this.getLinkedConnectorAt(e);if(!c.isNormalConnectorToHydrogen||!c.isNormalConnectorToHydrogen()){Kekule.ArrayUtils.pushUnique(b,c)}}return b},getLinkedNonHydrogenObjs:function(){var b=[];for(var g=0,d=this.getLinkedConnectorCount();g<d;++g){var c=this.getLinkedConnectorAt(g);var h=c.getConnectedObjs();for(var f=0,e=h.length;f<e;++f){if(h[f]!==this&&(!h[f].isHydrogenAtom||!h[f].isHydrogenAtom())){Kekule.ArrayUtils.pushUnique(b,h[f])}}}return b},getLinkedHydrogenAtoms:function(){var b=[];for(var g=0,d=this.getLinkedConnectorCount();g<d;++g){var c=this.getLinkedConnectorAt(g);var h=c.getConnectedObjs();for(var f=0,e=h.length;f<e;++f){if(h[f]!==this&&(h[f].isHydrogenAtom&&h[f].isHydrogenAtom())){Kekule.ArrayUtils.pushUnique(b,h[f])}}}return b},getStructureRelatedPropNames:function(){return["linkedConnectors"]},structureChange:function(b){this.clearStructureFlags();this.invokeEvent("structureChange",{origin:b||this})},clearStructureFlags:function(){},relayEvent:function($super,b,c){if(b==="structureChange"){this.structureChange(c.origin)}else{$super(b,c)}},doObjectChange:function($super,b){if(Kekule.ArrayUtils.intersect(b||[],this.getStructureRelatedPropNames()).length){this.structureChange()}}});Kekule.BaseStructureNode=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.BaseStructureNode",initialize:function($super,d,b,c){$super(d);if(b){this.setCoord2D(b)}if(c){this.setCoord3D(c)}},initProperties:function(){this.defineProp("zIndex2D",{dataType:DataType.INT,scope:Class.PropertyScope.PUBLISHED})},getStructureRelatedPropNames:function($super){return $super().concat(["coord2D","coord3D"])},getAutoIdPrefix:function(){return"n"},getContainerBox:function(c,b){var d=this.getAbsCoordOfMode(c,b);return Kekule.BoxUtils.createBox(d,d)},getContainerBox2D:function(b){return this.getContainerBox(Kekule.CoordMode.COORD2D,b)},getContainerBox3D:function(b){return this.getContainerBox(Kekule.CoordMode.COORD3D,b)}});Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.BaseStructureNode);Kekule.StereoParity={NONE:null,ODD:1,EVEN:2,UNKNOWN:0};Kekule.ChemStructureNode=Class.create(Kekule.BaseStructureNode,{CLASS_NAME:"Kekule.ChemStructureNode",initialize:function($super,d,b,c){$super(d);if(b){this.setCoord2D(b)}if(c){this.setCoord3D(c)}},initProperties:function(){this.defineProp("charge",{dataType:DataType.FLOAT,getter:function(){return this.getPropStoreFieldValue("charge")||0}});this.defineProp("radical",{dataType:DataType.INT});this.defineProp("parity",{dataType:DataType.INT});this.defineProp("isAnchor",{dataType:DataType.BOOL,serializable:false,getter:function(){var b=this.getParent();if(b&&b.indexOfAnchorNode){return b.indexOfAnchorNode(this)>=0}else{return false}},setter:function(b){if(b!==this.getIsAnchor()){var c=this.getParent();if(c){if(b&&c.appendAnchorNode()){c.appendAnchorNode(this)}else{if(!b&&c.removeAnchorNode){c.removeAnchorNode(this)}}}}}})},getStructureRelatedPropNames:function($super){return $super().concat(["charge","radical"])},getLabel:function(){return null},doGetComparisonPropNames:function($super,c){var b=$super(c);if(c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(c,"charge")){b.push("charge")}if(this._getComparisonOptionFlagValue(c,"radical")){b.push("radical")}}return b},doCompare:function($super,e,c){var b=$super(e,c);if(!b&&c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(c,"stereo")){var f=this.getParity()||Kekule.StereoParity.UNKNOWN;var d=(e.getParity&&e.getParity())||Kekule.StereoParity.UNKNOWN;b=this.doCompareOnValue(f,d,c)}}return b},getPrimaryIsotope:function(){return null},getLinkedChemNodes:function(f){var d=this.getLinkedObjs();var b=[];for(var e=0,c=d.length;e<c;++e){var g=d[e];if(g instanceof Kekule.ChemStructureNode&&(!f||!g.isHydrogenAtom||!g.isHydrogenAtom())){b.push(g)}}return b},getLinkedBonds:function(d){var b=[];for(var f=0,e=this.getLinkedConnectorCount();f<e;++f){var g=this.getLinkedConnectorAt(f);if((g instanceof Kekule.Bond)&&(!d||g.getBondType()===d)){b.push(g)}}return b},getLinkedMultipleBonds:function(){var g=Kekule.BondOrder;var d=[];for(var f=0,e=this.getLinkedConnectorCount();f<e;++f){var h=this.getLinkedConnectorAt(f);if((h instanceof Kekule.Bond)&&(h.getBondType()===Kekule.BondType.COVALENT)){var b=h.getBondOrder();if((b===g.DOUBLE)||(b===g.TRIPLE)||(b===g.QUAD)||(b===g.EXPLICIT_AROMATIC)){d.push(h)}}}return d},getLinkedDoubleBonds:function(){var g=Kekule.BondOrder;var d=[];for(var f=0,e=this.getLinkedConnectorCount();f<e;++f){var h=this.getLinkedConnectorAt(f);if((h instanceof Kekule.Bond)&&(h.getBondType()===Kekule.BondType.COVALENT)){var b=h.getBondOrder();if(b===g.DOUBLE){d.push(h)}}}return d},clearStructureFlags:function(){this.setPropStoreFieldValue("parity",Kekule.StereoParity.NONE)},isHydrogenAtom:function(){return false}});Kekule.RadicalType=Kekule.RadicalOrder;Kekule.AbstractAtom=Class.create(Kekule.ChemStructureNode,{CLASS_NAME:"Kekule.AbstractAtom",initialize:function($super,d,b,c){$super(d,b,c)},initProperties:function(){this.defineProp("explicitHydrogenCount",{dataType:DataType.INT,scope:Class.PropertyScope.PUBLISHED})},getAutoIdPrefix:function(){return"a"},getStructureRelatedPropNames:function($super){return $super().concat(["explicitHydrogenCount"])},doCompare:function($super,e,c){var b=$super(e,c);if(!b&&c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(c,"hydrogenCount")){var f=this.getHydrogenCount(true);var d=e.getHydrogenCount&&e.getHydrogenCount(true);b=this.doCompareOnValue(f,d,c)}}return b},getHydrogenCount:function(d){var b=this.getExplicitHydrogenCount()||0;if(d){var c=this.getLinkedHydrogenAtoms();b+=c.length||0}return b},setHydrogenCount:function(b){return this.setExplicitHydrogenCount(b)},isSaturated:function(){return !this.getLinkedMultipleBonds().length},mayContainElement:function(b){var c;if(typeof(b)==="string"){c=Kekule.ChemicalElementsDataUtil.getAtomicNumber(b)}else{c=b}return this.doMayContainElement(c)},doMayContainElement:function(b){return false}});Kekule.Atom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.Atom",initialize:function($super,f,b,c,d,e){$super(f,d,e);if(b||c){this.changeIsotope(b,c)}},initProperties:function(){this.defineProp("isotope",{dataType:"Kekule.Isotope",serializable:false});this.defineProp("isotopeId",{dataType:DataType.STRING,serializable:true,getter:function(){var b=this.getIsotope();return b?b.getIsotopeId():Kekule.Element.UNSET_ELEMENT},setter:function(c){var b=Kekule.IsotopeFactory.getIsotopeById(c);if(b){this.setIsotope(b)}}});this.defineProp("symbol",{dataType:DataType.STRING,serializable:false,getter:function(){var c=this.getIsotope();var b=c?c.getSymbol():Kekule.Element.UNSET_ELEMENT;return b},setter:function(b){this.changeElement(b)}});this.defineProp("atomicNumber",{dataType:DataType.INTEGER,serializable:false,getter:function(){var b=this.getIsotope();return b?b.getAtomicNumber():0},setter:function(b){this.changeElement(b)}});this.defineProp("massNumber",{dataType:DataType.INTEGER,getter:function(){var b=this.getIsotope();return b?b.getMassNumber():Kekule.Isotope.UNSET_MASSNUMBER},setter:function(b){this.changeMassNumber(b)}});this.defineProp("isotopeAlias",{dataType:DataType.STRING,getter:function(){var b=this.getIsotope();return b?b.getIsotopeAlias():undefined},setter:function(b){this.changeElement(b)}});this.defineProp("atomType",{dataType:DataType.OBJECT,serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("atomTypeId",{dataType:DataType.STRING,getter:function(){var b=this.getPropStoreFieldValue("atomType");return b?b.id:Kekule.AtomType.UNSET_ATOMTYPE},setter:function(c){if(this.isNormalAtom()){var b=Kekule.AtomTypeDataUtil.getAtomTypeFromId(this.getAtomicNumber(),c);this.setAtomType(b)}}});this.defineProp("hybridizationType",{dataType:DataType.INT,enumSource:Kekule.HybridizationType})},getAutoIdPrefix:function(){return"a"},getStructureRelatedPropNames:function($super){return $super().concat(["isotope","atomType"])},doGetComparisonPropNames:function($super,c){var b=$super(c);if(c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(c,"atom")){b.push("atomicNumber")}if(this._getComparisonOptionFlagValue(c,"mass")){b.push("massNumber")}}return b},getPrimaryIsotope:function(){return this.getIsotope()},getLabel:function(){return""+(this.getMassNumber()||"")+this.getSymbol()},doMayContainElement:function(b){return this.getAtomicNumber()===b},changeIsotope:function(b,c){if(b===Kekule.Element.UNSET_ELEMENT){c=Kekule.Isotope.UNSET_MASSNUMBER}else{if(!b){b=this.getAtomicNumber()}}if(!c){c=Kekule.Isotope.UNSET_MASSNUMBER}if(this.getAtomicNumber()!==b){this.setAtomType(Kekule.AtomType.UNSET_ATOMTYPE)}var d=Kekule.IsotopeFactory.getIsotope(b,c);this.setIsotope(d)},changeElement:function(b){return this.changeIsotope(b,Kekule.Isotope.UNSET_MASSNUMBER)},changeMassNumber:function(b){return this.changeIsotope(null,b)},isElement:function(b){return(this.getSymbol()===b)||(this.getAtomicNumber()===b)},isNormalAtom:function(){var b=this.getIsotope();return b?b.isNormalElement():false},isHydrogenAtom:function(){return this.isElement(1)&&(!this.getMassNumber()||this.getMassNumber()<=1)},_getCurrCovalentBondsInfo:function(){var g=0;var f=0;for(var e=0,c=this.getLinkedConnectorCount();e<c;++e){var b=this.getLinkedConnectorAt(e);if((b instanceof Kekule.Bond)&&(b.getBondType()==Kekule.BondType.COVALENT)){var d=b.getBondValence();g+=d;if(d>f){f=d}}}return{valenceSum:g,maxValence:f}},_getCurrIonicBondsInfo:function(){var g=0;var f=0;for(var e=0,c=this.getLinkedConnectorCount();e<c;++e){var b=this.getLinkedConnectorAt(e);if((b instanceof Kekule.Bond)&&(b.getBondType()==Kekule.BondType.IONIC)){var d=b.getBondValence();g+=d;if(d>f){f=d}}}return{valenceSum:g,maxValence:f}},guessAtomType:function(){if(this.isNormalAtom()){var d=null,h=null;var g=this._getCurrCovalentBondsInfo();var f=Kekule.AtomTypeDataUtil.getAllAtomTypes(this.getAtomicNumber());if(f){for(var e=0,b=f.length;e<b;++e){var c=f[e];h=c;if(c.bondOrderSum>=g.valenceSum){d=c;if(c.maxBondOrder>=g.maxValence){return c}}}return d?d:h}}return null},getProximalAtomType:function(){return this.getAtomType()||this.guessAtomType()},getImplicitValence:function(){if(this.isNormalAtom()){var d=this._getCurrCovalentBondsInfo();var e=d.valenceSum;var c=Math.round(this.getCharge()||0);var b=Kekule.ValenceUtils.getImplicitValence(this.getAtomicNumber(),c,e);return b}else{return 0}},getImplicitHydrogenCount:function(){if(this.isNormalAtom()){var d=this._getCurrCovalentBondsInfo();var c=this._getCurrIonicBondsInfo();var e=this.getImplicitValence();var b=Kekule.RadicalOrder.getRadicalElectronCount(this.getRadical());e-=b;return Math.max(e-d.valenceSum-c.valenceSum,0)}else{return 0}},getHydrogenCount:function(c){var b;if(Kekule.ObjUtils.isUnset(this.getExplicitHydrogenCount())){b=this.getImplicitHydrogenCount()||0}else{b=this.getExplicitHydrogenCount()||0}if(c){b+=this.getLinkedHydrogenAtoms().length||0}return b},getAtomicMass:function(){var b=null;var c=this.getIsotope();if(c){b=c.getExactMass()||c.getNaturalMass()}return b}});Kekule.PseudoatomType={DUMMY:"dummy",ANY:"any",HETERO:"hetero",CUSTOM:"custom"};Kekule.Pseudoatom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.Pseudoatom",initialize:function($super,f,b,e,c,d){$super(f,c,d);if(b){this.setAtomType(b)}if(e&&(b==Kekule.PseudoatomType.CUSTOM)){this.setSymbol(e)}},initProperties:function(){this.defineProp("atomType",{dataType:DataType.STRING,enumSource:Kekule.PseudoatomType});this.defineProp("symbol",{dataType:DataType.STRING,getter:function(){var c=this.getAtomType();var d=Kekule.PseudoatomType;var b=Kekule.ChemStructureNodeLabels;return(c===d.DUMMY)?b.DUMMY_ATOM:(c===d.ANY)?b.ANY_ATOM:(c===d.HETERO)?b.HETERO_ATOM:this.getPropStoreFieldValue("symbol")||b.CUSTOM_ATOM},setter:function(d){var e=Kekule.PseudoatomType;var b=Kekule.ChemStructureNodeLabels;if(d){var c=(d===b.DUMMY_ATOM)?e.DUMMY:(d===b.ANY_ATOM)?e.ANY:(d===b.HETERO_ATOM)?e.HETERO:e.CUSTOM;this.setAtomType(c)}this.setPropStoreFieldValue("symbol",d)}})},getStructureRelatedPropNames:function($super){return $super().concat(["atomType","symbol"])},getPrimaryIsotope:function(){return null},getLabel:function(){return this.getSymbol()},doGetComparisonPropNames:function($super,c){var b=$super(c);if(c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(c,"atom")){b.push("atomType")}}return b},doCompare:function($super,d,c){var b=$super(d,c);if(!b&&c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(c,"atom")){if(this.getAtomType()===Kekule.PseudoatomType.CUSTOM){var f=this.getSymbol();var e=d.getSymbol&&d.getSymbol();b=this.doCompareOnValue(f,e,c)}}}return b},doMayContainElement:function(e){var d=Kekule.PseudoatomType;var c=this.getAtomType();if(c===d.ANY){return true}else{if(c===d.HETERO){if([1,6].indexOf(e)>=0){return false}else{var b=Kekule.ChemicalElementsDataUtil.getElementInfo(e);return(eleminfo.chemicalSerie==="Nonmetals")}}else{return false}}}});Kekule.VariableAtom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.VariableAtom",initProperties:function(){this.defineProp("allowedIsotopeIds",{dataType:DataType.ARRAY,getter:function(c){var b=this.getPropStoreFieldValue("allowedIsotopeIds");if((!b)&&c){b=[];this.setPropStoreFieldValue("allowedIsotopeIds",b)}return b}});this.defineProp("disallowedIsotopeIds",{dataType:DataType.ARRAY,getter:function(c){var b=this.getPropStoreFieldValue("disallowedIsotopeIds");if((!b)&&c){b=[];this.setPropStoreFieldValue("disallowedIsotopeIds",b)}return b}});this.defineProp("allowedIsotopes",{dataType:DataType.ARRAY,setter:null,getter:function(){return this._getIsotopesFromIds(this.getAllowedIsotopeIds())}});this.defineProp("disallowedIsotopes",{dataType:DataType.ARRAY,setter:null,getter:function(){return this._getIsotopesFromIds(this.getDisallowedIsotopeIds())}})},getStructureRelatedPropNames:function($super){return $super().concat(["allowedIsotopeIds","disallowedIsotopeIds"])},getPrimaryIsotope:function(){if(this.isDisallowedList()){return null}else{var b=this.getAllowedIsotopeIds();var c=b?b[0]:null;return c?Kekule.IsotopeFactory.getIsotopeById(c):null}},getLabel:function(){return Kekule.ChemStructureNodeLabels.VARIABLE_ATOM},doCompare:function($super,f,h){var i=$super(f,h);if(!i&&h.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(h,"atom")){var g=Kekule.ArrayUtils;var c=this.getAllowedIsotopeIds();var b=f.getAllowedIsotopeIds&&f.getAllowedIsotopeIds();if(c){c=g.clone(c).sort();if(b&&b.length){b=g.clone(b).sort()}i=this.doCompareOnValue(c,b,h)}else{if(b){i=1}else{var e=this.getDisallowedIsotopeIds();var d=f.getDisallowedIsotopeIds&&f.getDisallowedIsotopeIds();if(e&&e.length){e=g.clone(e).sort()}if(d&&d.length){d=g.clone(d).sort()}i=this.doCompareOnValue(e,d,h)}}}}return i},doMayContainElement:function(d){var c=function(n,h){if(!h){return false}for(var g=0,e=h.length;g<e;++g){var m=h[g];var k=Kekule.IsotopesDataUtil.getIsotopeIdDetail(m);var j=k.symbol;var f=Kekule.ChemicalElementsDataUtil.getAtomicNumber(j);if(f===n){return true}}return false};var b=this.getAllowedIsotopeIds();if(b){return c(d,b)}else{b=this.getDisallowedIsotopeIds();if(b){return !c(d,b)}}},isDisallowedList:function(){return this.getDisallowedIsotopeIds()&&(!this.getAllowedIsotopeIds())},isListEmpty:function(){var c=this.getAllowedIsotopeIds();var b=!c||!c.length;if(b){c=this.getDisallowedIsotopeIds();b=!c||!c.length}return b},fetchAllowedIsotopeIds:function(){return this.doGetAllowedIsotopeIds(true)},fetchDisallowedIsotopeIds:function(){return this.doGetDisallowedIsotopeIds(true)},_getIsotopesFromIds:function(f){if(!f){return null}var b=[];for(var e=0,c=f.length;e<c;++e){var g=f[e];var d=Kekule.IsotopeFactory.getIsotopeById(g);if(d){b.push(d)}}return b}});Kekule.MolecularFormula=Class.create(ObjectEx,{CLASS_NAME:"Kekule.MolecularFormula",initialize:function($super,b){$super();this.setPropStoreFieldValue("sections",[]);if(b){this.setPropStoreFieldValue("parent",b)}this.setBubbleEvent(true)},initProperties:function(){this.defineProp("parent",{dataType:"Kekule.StructureFragment",serializable:false,setter:null,scope:Class.PropertyScope.PUBLIC});this.defineProp("sections",{dataType:DataType.ARRAY,setter:null});this.defineProp("charge",{dataType:DataType.FLOAT,getter:function(){return this.getPropStoreFieldValue("charge")||0}});this.defineProp("radical",{dataType:DataType.INT,getter:function(){return this.getPropStoreFieldValue("radical")||0}})},getHigherLevelObj:function(){return this.getParent()},isEmpty:function(){return this.getSectionCount()<=0},notifySectionsChanged:function(){this.notifyPropSet("sections",this.getPropStoreFieldValue("sections"))},createSectionItem:function(c,e,d){var b={obj:c,count:e||1};if(d){c.setCharge(d)}if(c.setParent){c.setParent(this.getParent())}return b},getTotalCharge:function(){var b=0;var e=this.getSections();for(var d=0,c=e.length;d<c;++d){if(e[d].obj.getCharge){b+=e[d].obj.getCharge()*(section.count||1)}}if(this.getCharge()){b+=this.getCharge()}return b},indexOfObj:function(c){var e=this.getSections();for(var d=0,b=e.length;d<b;++d){if(e[d].obj==c){return d}}return -1},getSectionCount:function(){return this.getSections().length},getSectionAt:function(b){return this.getSections()[b]},getSectionCharge:function(c){var b=0;var d;if(typeof(c)!="object"){d=this.getSectionAt(c)}else{d=c}if(d.obj.getCharge){b+=(d.obj.getCharge()||0)}return b},appendSection:function(c,e,d){var b=this.createSectionItem(c,e,d);this.getSections().push(b);this.notifySectionsChanged();return b},insertSection:function(d,c,f,e){var b=this.createSectionItem(c,f,e);this.getSections().splice(d,0,b);this.notifySectionsChanged();return b},removeSectionAt:function(b){var c=this.getSections().splice(b,1);if(c){this.notifySectionsChanged()}return c},clear:function(){this.beginUpdate();try{this.setCharge(null);this.setRadical(null);this.setPropStoreFieldValue("sections",[]);this.notifySectionsChanged()}finally{this.endUpdate()}},removeObj:function(b){var c=this.indexOfObj(b);if(c>=0){var d=this.removeSectionAt(c);this.notifySectionsChanged()}else{return null}},getMaxNestedLevel:function(){var b=0;for(var e=0,c=this.getSectionCount();e<c;++e){var f=this.getSectionAt(e);if(f.obj instanceof Kekule.MolecularFormula){var d=f.obj.getMaxNestedLevel()+1;if(d>b){b=d}}}return b},getSimpleIsotopeMaps:function(){}});Kekule.StructureConnectionTable=Class.create(ObjectEx,{CLASS_NAME:"Kekule.StructureConnectionTable",TRAVERS_VISITED_KEY:"__$ctabTraversVisited__",initialize:function($super,b,c){$super();if(b){this.setOwner(b)}if(c){this.setPropStoreFieldValue("parent",c)}},initProperties:function(){this.defineProp("owner",{dataType:"Kekule.ChemSpace",serializable:false,scope:Class.PropertyScope.PUBLIC,setter:function(b){if(b!=this.getPropStoreFieldValue("owner")){this.setPropStoreFieldValue("owner",b);this.ownerChanged(b)}}});this.defineProp("parent",{dataType:"Kekule.StructureFragment",serializable:false,scope:Class.PropertyScope.PUBLIC,setter:function(b){if(b!=this.getPropStoreFieldValue("parent")){this.setPropStoreFieldValue("parent",b);this.parentChanged(b)}}});this.defineProp("nodes",{dataType:DataType.ARRAY});this.defineProp("anchorNodes",{dataType:DataType.ARRAY,setter:null});this.defineProp("connectors",{dataType:DataType.ARRAY});this.defineProp("nonHydrogenNodes",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:false,setter:null,getter:function(){var b=[];for(var d=0,c=this.getNodeCount();d<c;++d){var e=this.getNodeAt(d);if(e instanceof Kekule.ChemStructureNode){if(!e.isHydrogenAtom||!e.isHydrogenAtom()){b.push(e)}}}return b}});this.defineProp("nonHydrogenConnectors",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:false,setter:null,getter:function(){var b=[];for(var d=0,c=this.getConnectorCount();d<c;++d){var e=this.getConnectorAt(d);if(!e.isNormalConnectorToHydrogen||!e.isNormalConnectorToHydrogen()){b.push(e)}}return b}})},initPropValues:function($super){$super();this.setPropStoreFieldValue("nodes",[]);this.setPropStoreFieldValue("anchorNodes",[]);this.setPropStoreFieldValue("connectors",[])},getHigherLevelObj:function(){return this.getParent()||this.getOwner()},doSaveProp:function(o,d,h,w){var p=d.name;switch(p){case"anchorNodes":var e=[];for(var v=0,r=o.getAnchorNodeCount();v<r;++v){var q=o.getAnchorNodeAt(v);var f=o.indexOfNode(q);e.push(f)}var g=w.createChildStorageNode(h,w.propNameToStorageName(p),true);w.save(e,g);return true;break;case"connectors":var g=w.createChildStorageNode(h,w.propNameToStorageName(p),true);for(var v=0,r=o.getConnectorCount();v<r;++v){var x=o.getConnectorAt(v);var b=w.getNameForArrayItemStorageNode(x);var n=w.appendArrayItemStorageNode(g,w.propNameToStorageName(b),w.isArray(x));w.setStorageNodeExplicitType(n,w.getValueExplicitType(x));w.save(x,n);var m=[];for(var t=0,s=x.getConnectedObjCount();t<s;++t){var u=x.getConnectedObjAt(t);var f=o.indexOfChild(u);if(f>=0){m.push(f)}else{var c=o.indexStackOfChild(u);if((c!==null)&&(typeof(c)!=="undefined")){m.push(c)}}}if(m.length){var y=w.createChildStorageNode(n,w.propNameToStorageName("connectedObjs"),true);w.save(m,y)}}return true;break;default:return false}},doLoadProp:function(n,c,j,t){var o=c.name;switch(o){case"anchorNodes":var e=[];var f=t.getChildStorageNode(j,t.propNameToStorageName(o));t.load(e,f);n.__load_anchorNodes_indexes=e;return true;break;case"connectors":var f=t.getChildStorageNode(j,t.propNameToStorageName(o));var d=t.getAllArrayItemStorageNodes(f);var b;for(var r=0,q=d.length;r<q;++r){var m=d[r];var u=t.getStorageNodeExplicitType(m)||t.getStorageNodeName(m);if(u){b=DataType.createInstance(u);t.load(b,m);var v=t.getChildStorageNode(m,t.propNameToStorageName("connectedObjs"));if(v){var k=[];t.load(k,v);b.__load_connectedObj_indexes=k}var p=t.getChildStorageNode(m,t.propNameToStorageName("connectedNodes"));if(p){var g=[];t.load(g,p);b.__load_connectedNode_indexes=g}var h=t.getChildStorageNode(m,t.propNameToStorageName("connectedConnectors"));if(h){var s=[];t.load(s,h);b.__load_connectedConnector_indexes=s}n.appendConnector(b)}}return true;break;default:return false}},loaded:function($super){if(this.__load_anchorNodes_indexes){for(var g=0,c=this.__load_anchorNodes_indexes.length;g<c;++g){var f=this.__load_anchorNodes_indexes[g];this.appendAnchorNode(this.getNodeAt(f))}delete this.__load_anchorNodes_indexes}for(var g=0,c=this.getConnectorCount();g<c;++g){var b=this.getConnectorAt(g);if(b.__load_connectedObj_indexes){for(var e=0,d=b.__load_connectedObj_indexes.length;e<d;++e){var f=b.__load_connectedObj_indexes[e];var h;if(typeof(f)=="object"){h=this.getChildAtIndexStack(f)}else{h=this.getChildAt(f)}if(h){b.appendConnectedObj(h)}}delete b.__load_connectedObj_indexes}if(b.__load_connectedNode_indexes){for(var e=0,d=b.__load_connectedNode_indexes.length;e<d;++e){var f=b.__load_connectedNode_indexes[e];if(typeof(f)=="object"){b.appendConnectedObj(this.getNodeAtIndexStack(f))}else{b.appendConnectedObj(this.getNodeAt(f))}}delete b.__load_connectedNode_indexes}if(b.__load_connectedConnector_indexes){for(var e=0,d=b.__load_connectedConnector_indexes.length;e<d;++e){var f=b.__load_connectedConnector_indexes[e];b.appendConnectedObj(this.getConnectorAt(f))}delete b.__load_connectedConnector_indexes}}this.ownerChanged(this.getOwner());this.parentChanged(this.getParent());$super()},notifyNodesChanged:function(){this.notifyPropSet("nodes",this.getPropStoreFieldValue("nodes"))},notifyAnchorNodesChanged:function(){this.notifyPropSet("anchorNodes",this.getPropStoreFieldValue("anchorNodes"))},notifyConnectorsChanged:function(){this.notifyPropSet("connectors",this.getPropStoreFieldValue("connectors"))},ownerChanged:function(c){for(var d=0,b=this.getNodeCount();d<b;++d){this.getNodeAt(d).setOwner(c)}for(var d=0,b=this.getConnectorCount();d<b;++d){this.getConnectorAt(d).setOwner(c)}},parentChanged:function(d){for(var c=0,b=this.getNodeCount();c<b;++c){this.getNodeAt(c).setParent(d)}for(var c=0,b=this.getConnectorCount();c<b;++c){this.getConnectorAt(c).setParent(d)}},isEmpty:function(){return(this.getNodeCount()<=0)&&(this.getConnectorCount()<=0)},getNodeById:function(e){var c=this.getNodes();for(var d=0,b=c.length;d<b;++d){if(c[d].getId()==e){return c[d]}}return null},getConnectorById:function(e){var c=this.getConnectors();for(var d=0,b=c.length;d<b;++d){if(c[d].getId()==e){return c[d]}}return null},getObjectById:function(c){var b=this.getNodeById(c);return b?b:this.getConnectorById(c)},getNodeCount:function(){return this.getNodes().length},getNodeAt:function(b){return this.getNodes()[b]},indexOfNode:function(b){return this.getNodes().indexOf(b)},hasNode:function(e,c){var f=this.indexOfNode(e)>=0;if((!f)&&c){for(var d=0,b=this.getNodeCount();d<b;++d){var g=this.getNodeAt(d);if(g.hasNode){f=g.hasNode(e,true)}if(f){break}}}return f},indexStackOfNode:function(f){var d=this.indexOfNode(f);if(d>=0){return d}else{var b=null;for(var e=0,c=this.getNodeCount();e<c;++e){var g=this.getNodeAt(e);if(g.indexStackOfNode){b=g.indexStackOfNode(f);if(!Kekule.ObjUtils.isUnset(b)){if(typeof(b)!="object"){b=[b]}b.unshift(e);return b}}}return b}},getNodeAtIndexStack:function(d){d=Kekule.ArrayUtils.toArray(d);if(d.length<=0){return null}else{var e=this.getNodeAt(d[0]);for(var c=1,b=d.length;c<b;++c){if(e&&e.getNodeAt){e=e.getNodeAt(d[c])}else{return null}}return e}},appendNode:function(c){var b=Kekule.ArrayUtils.pushUniqueEx(this.getNodes(),c);if(b.isPushed){if(c.setOwner){c.setOwner(this.getOwner())}if(c.setParent){c.setParent(this.getParent())}this.notifyNodesChanged()}return b.index},insertNodeAt:function(e,c){var d=this.indexOfNode(e);var b=this.getNodes();if(Kekule.ObjUtils.isUnset(c)||(c<0)){c=b.length}if(d>=0){b.splice(d,1);b.splice(c,0,e)}else{b.splice(c,0,e);if(e.setOwner){e.setOwner(this.getOwner())}if(e.setParent){e.setParent(this.getParent())}}this.notifyNodesChanged();return c},setNodeIndex:function(e,c){var b=this.getNodes();var d=this.indexOfNode(e);if(d>=0){b.splice(d,1);b.splice(c,0,e)}},removeNodeAt:function(c,b){var d=this.getNodes()[c];if(d){if(!b){d.removeThisFromLinkedConnector()}this.getNodes().splice(c,1);if(d.setOwner){d.setOwner(null)}if(d.setParent){d.setParent(null)}this.notifyNodesChanged()}},removeNode:function(d,b){var c=this.getNodes().indexOf(d);if(c>=0){this.removeNodeAt(c,b)}},replaceNode:function(d,q){if(!this.hasNode(d)){return this}else{this.insertBefore(q,d);var b=this.getAnchorNodes();var p=b.indexOf(d);if(p>=0){b.splice(p,1,[q])}var c=Kekule.ArrayUtils.clone(d.getLinkedConnectors());for(var o=0,e=c.length;o<e;++o){var f=c[o];f.replaceConnectedObj(d,q)}if(d.getNodes&&d.getCrossConnectors){var m=Kekule.ArrayUtils.clone(d.getCrossConnectors());for(var o=0,e=m.length;o<e;++o){var f=m[o];if(this.indexOfConnector(f)>=0){for(var h=0,g=f.getConnectedObjCount();h<g;++h){var n=f.getConnectedObjAt(h);if(d.indexOfChild(n)>=0){f.replaceConnectedObj(n,q)}}}f.replaceConnectedObj(d,q)}}this.removeNode(d)}},clearNodes:function(){this.clearAnchorNodes();this.setPropStoreFieldValue("nodes",[]);this.notifyAnchorNodesChanged();this.notifyNodesChanged()},sortNodes:function(b){if(b){this.getNodes().sort(b);this.notifyNodesChanged()}else{Kekule.error(Kekule.$L("ErrorMsg.SORT_FUNC_UNSET"))}},nodesHasCoord2D:function(d){var c=this.getNodes();for(var e=0,b=c.length;e<b;++e){if(c[e].hasCoord2D(d)){return true}}return false},nodesHasCoord3D:function(d){var c=this.getNodes();for(var e=0,b=c.length;e<b;++e){if(c[e].hasCoord3D(d)){return true}}return false},_createAtom:function(b,c,d,f){var e=new Kekule.Atom(null,b,c,d,f);return e},appendAtom:function(b,c,d,f){var e=this._createAtom(b,c,d,f);if(e){this.appendNode(e)}return e},getAnchorNodeCount:function(){return this.getAnchorNodes().length},indexOfAnchorNode:function(b){return this.getAnchorNodes().indexOf(b)},getAnchorNodeAt:function(b){return this.getAnchorNodes()[b]},appendAnchorNode:function(c){if(!c){return -1}if(this.getNodes().indexOf(c)>=0){var b=Kekule.ArrayUtils.pushUniqueEx(this.getAnchorNodes(),c);if(b.isPushed){this.notifyAnchorNodesChanged()}return b.index}else{return -1}},removeAnchorNodeAt:function(b){var c=this.getAnchorNodes()[b];if(c){this.getAnchorNodes().splice(b,1);this.notifyAnchorNodesChanged()}},removeAnchorNode:function(c){var b=this.getAnchorNodes().indexOf(c);if(b>=0){this.removeAnchorNodeAt(b)}},clearAnchorNodes:function(){this.setPropStoreFieldValue("anchorNodes",[]);notifyAnchorNodesChanged()},getConnectorCount:function(){return this.getConnectors().length},indexOfConnector:function(b){return this.getConnectors().indexOf(b)},getConnectorAt:function(b){return this.getConnectors()[b]},indexStackOfConnector:function(d){var e=this.indexOfConnector(d);if(e>=0){return e}else{var b=null;for(var f=0,c=this.getNodeCount();f<c;++f){var g=this.getNodeAt(f);if(g.indexStackOfConnector){b=g.indexStackOfConnector(d);if(!Kekule.ObjUtils.isUnset(b)){if(typeof(b)!="object"){b=[b]}b.unshift(f);return b}}}return b}},getConnectorAtIndexStack:function(d){d=Kekule.ArrayUtils.toArray(d);if(d.length<=0){return null}else{if(d.length===1){return this.getConnectorAt(d[0])}else{var b=d.length-1;var e=this.getNodeAt(d[0]);for(var c=1;c<b;++c){if(e&&e.getNodeAt){e=e.getNodeAt(d[c])}else{return null}}if(e){return e.getConnectorAt(d[b])}else{return null}}}},appendConnector:function(b){var c=Kekule.ArrayUtils.pushUniqueEx(this.getConnectors(),b);if(c.isPushed){if(b.setOwner){b.setOwner(this.getOwner())}if(b.setParent){b.setParent(this.getParent())}this.notifyConnectorsChanged()}return c.index},insertConnectorAt:function(c,d){var e=this.indexOfConnector(c);var b=this.getConnectors();if(Kekule.ObjUtils.isUnset(d)||(d<0)){d=b.length}if(e>=0){b.splice(e,1);b.splice(d,0,c)}else{b.splice(d,0,c);if(c.setOwner){c.setOwner(this.getOwner())}if(c.setParent){c.setParent(this.getParent())}}this.notifyConnectorsChanged()},setConnectorIndex:function(c,d){var b=this.getConnectors();var e=this.indexOfConnector(c);if(e>=0){b.splice(e,1);b.splice(d,0,c)}},removeConnectorAt:function(d,b){var c=this.getConnectors()[d];if(c){if(!b){c.removeThisFromConnectedObjs()}this.getConnectors().splice(d,1);if(c.setOwner){c.setOwner(null)}if(c.setParent){c.setParent(null)}this.notifyConnectorsChanged()}},removeConnector:function(c,b){var d=this.getConnectors().indexOf(c);if(d>=0){this.removeConnectorAt(d,b)}},clearConnectors:function(){this.setPropStoreFieldValue("connectors",[]);this.notifyConnectorsChanged()},hasConnector:function(c,d){var f=this.indexOfConnector(c)>=0;if((!f)&&d){for(var e=0,b=this.getNodeCount();e<b;++e){var g=this.getNodeAt(e);if(g.hasConnector){f=g.hasConnector(c,true)}if(f){break}}}return f},sortConnectors:function(b){if(b){this.getConnectors().sort(b);this.notifyConnectorsChanged()}else{Kekule.error(Kekule.$L("ErrorMsg.SORT_FUNC_UNSET"))}},_createBond:function(e,d,c){var j=[];for(var h=0,g=e.length;h<g;++h){var f=e[h];if(DataType.isSimpleValue(f)){f=this.getNodeAt(f)}j.push(f)}var b=new Kekule.Bond(null,j,d,null,c);return b},appendBond:function(d,c,b){var e=this._createBond(d,c,b);if(e){this.appendConnector(e)}return e},_getObjsNeedToBeCascadeRemoved:function(m,k){var o=[];var n=m.getLinkedConnectors?m.getLinkedConnectors():[];for(var g=0,c=n.length;g<c;++g){var d=n[g];if((!k)||(k.indexOf(d)<0)){if(d.getConnectedObjs().length<=2){Kekule.ArrayUtils.pushUnique(o,d)}}}if(m instanceof Kekule.ChemStructureNode){}else{if(m instanceof Kekule.ChemStructureConnector){var h=m.getConnectedObjs();for(var g=0,c=h.length;g<c;++g){var f=h[g];if((!k)||(k.indexOf(f)<0)){if(f instanceof Kekule.ChemStructureNode){if(f.getLinkedConnectors().length<=1){Kekule.ArrayUtils.pushUnique(o,f)}}}}}else{}}var e=[].concat(o);e.push(m);var j=[];for(var g=0,c=o.length;g<c;++g){var f=o[g];if(f!==m){var b=this._getObjsNeedToBeCascadeRemoved(f,e)}Kekule.ArrayUtils.pushUnique(j,b)}Kekule.ArrayUtils.pushUnique(o,j);return o},removeChildObj:function(h,e,c){var g;if(e){g=this._getObjsNeedToBeCascadeRemoved(h);Kekule.ArrayUtils.pushUnique(g,h)}else{g=[h]}for(var d=0,b=g.length;d<b;++d){var f=g[d];if(f instanceof Kekule.BaseStructureConnector){this.removeConnector(f)}else{if(f instanceof Kekule.BaseStructureNode){this.removeNode(f)}}}if(c){for(var d=g.length-1;d>=0;--d){var f=g[d];if(f.finalize){f.finalize()}}}},removeChild:function($super,b){return this.removeChildObj(b)||$super(b)},deleteChildObj:function(c,b){return this.removeChildObj(c,b,true)},hasChildObj:function(b){return this.hasNode(b)||this.hasConnector(b)},getNextSiblingOfChild:function(c){if(c instanceof Kekule.ChemStructureNode){var b=this.indexOfNode(c);if(b>=0){return this.getNodeAt(b+1)}}else{if(c instanceof Kekule.ChemStructureConnector){var b=this.indexOfConnector(c);if(b>=0){return this.getConnectorAt(b+1)}}}return null},insertBefore:function(d,b){if(d instanceof Kekule.BaseStructureNode){var c=this.indexOfNode(b);return this.insertNodeAt(d,c)}else{if(d instanceof Kekule.BaseStructureConnector){var c=this.indexOfConnector(b);return this.insertConnectorAt(d,c)}else{return -1}}},clear:function(){this.clearNodes();this.clearConnectors()},getChildCount:function(){return this.getNodeCount()+this.getConnectorCount()},getChildAt:function(c){var b=this.getNodeCount();if(c<b){return this.getNodeAt(c)}else{return this.getConnectorAt(c-b)}},indexOfChild:function(d){var b;if(d instanceof Kekule.BaseStructureNode){b=this.indexOfNode(d)}else{if(d instanceof Kekule.BaseStructureConnector){b=this.indexOfConnector(d);if(b>=0){var c=this.getNodeCount();b+=c}}else{b=-1}}return b},indexStackOfChild:function(d){var b;if(d instanceof Kekule.BaseStructureNode){b=this.indexStackOfNode(d)}else{if(d instanceof Kekule.BaseStructureConnector){var c=this.getNodeCount();b=this.indexStackOfConnector(d);if(b.length){b[b.length-1]+=c}else{b+=c}}else{b=-1}}return b},getChildAtIndexStack:function(d){d=Kekule.ArrayUtils.toArray(d);if(d.length<=0){return null}else{var e=this.getChildAt(d[0]);for(var c=1,b=d.length;c<b;++c){if(e&&e.getChildAt){e=e.getChildAt(d[c])}else{return null}}return e}},isSubFragment:function(b){return(b.getNodeCount&&(b.getNodeCount()>0))},getSubFragments:function(){var b=[];for(var d=0,c=this.getNodeCount();d<c;++d){var e=this.getNodeAt(d);if(this.isSubFragment(e)){b.push(e)}}return b},hasSubFragments:function(){var b=this.getSubFragments();return b&&b.length},getLeafNodes:function(){var b=[];for(var e=0,d=this.getNodeCount();e<d;++e){var f=this.getNodeAt(e);if(!this.isSubFragment(f)){b.push(f)}else{if(f.getLeafNodes){var c=f.getLeafNodes();b=b.concat(c)}}}return b},findDirectChildOfObj:function(b){var c=b;while(c&&this.indexOfChild(c)<0){c=c.getParent?c.getParent():null}return c},getAllChildConnectors:function(){var b=[].concat(this.getConnectors());var e=this.getSubFragments();for(var d=0,c=e.length;d<c;++d){if(e[d].getAllChildConnectors){b=b.concat(e[d].getAllChildConnectors())}}return b},getAllContainingConnectors:function(){return this.getAllChildConnectors()},getIsotopeMaps:function(){var b=this.getNodes();if(b.length<=0){return[]}else{var h=function(r,n,q,o){var s=false;for(var l=0,i=r.length;l<i;++l){if(n.isSame(r[l].isotope)){s=true;r[l].count+=q;r[l].charge+=o||0}}if(!s){var p={isotope:n,count:q,charge:d.getCharge()||0};r.push(p)}return r};var m=[];for(var f=0,e=b.length;f<e;++f){var d=b[f];if(d instanceof Kekule.StructureFragment){var j=d.getIsotopeMaps();for(var f=0,e=j.length;f<e;++f){m=h(m,j[f].isotope,j[f].count,j[f].charge||0)}}else{if(d instanceof Kekule.Atom){var k=d.getIsotope();m=h(m,d.getIsotope(),1,d.getCharge()||0);var g=d.getHydrogenCount();if(g>0){var c=Kekule.IsotopeFactory.getIsotope(1);m=h(m,c,g,0)}}}}}return m},calcFormula:function(){var f=this.getIsotopeMaps();if(f.length<=0){return null}var b=new Kekule.MolecularFormula();for(var e=0,c=f.length;e<c;++e){var d=new Kekule.Atom();d.setIsotope(f[e].isotope);b.appendSection(d,f[e].count,f[e].charge)}return b},getNodesContainBox:function(b,f,d){var j=(f===Kekule.CoordMode.COORD3D);var k={};for(var g=0,e=b.length;g<e;++g){var c=b[g];var h=c.getAbsCoordOfMode(f,d);if(g==0){k.x1=k.x2=h.x;k.y1=k.y2=h.y;if(j){k.z1=k.z2=h.z}}else{(h.x<k.x1)?k.x1=h.x:((h.x>k.x2)?k.x2=h.x:null);(h.y<k.y1)?k.y1=h.y:((h.y>k.y2)?k.y2=h.y:null);if(j){(h.z<k.z1)?k.z1=h.z:((h.z>k.z2)?k.z2=h.z:null)}}}return k},getContainerBox:function(c,b){return this.getNodesContainBox(this.getNodes(),c,b)},getContainerBox2D:function(c){var b=this.getContainerBox(Kekule.CoordMode.COORD2D,c);b.width=b.x2-b.x1;b.height=b.y2-b.y1;return b},getContainerBox3D:function(c){var b=this.getContainerBox(Kekule.CoordMode.COORD3D,c);b.deltaX=b.x2-b.x1;b.deltaY=b.y2-b.y1;b.deltaZ=b.z2-b.z1;return b},traverse:function(j,b,f,g){var n={nodes:[],connectors:[]};var h="__$ctabTraverseVisited__";var m=a.clone(g||this.getNodes());for(var e=0,c=m.length;e<c;++e){m[e][this.TRAVERS_VISITED_KEY]=false}while(m.length){var d;if(b&&(m.indexOf(b)>=0)){d=b}else{d=m[0]}var k=this._doTravers(j,d,f,g);n.nodes=n.nodes.concat(k.nodes);n.connectors=n.connectors.concat(k.connectors);m=a.exclude(m,k.nodes)}return n},_doTravers:function(d,g,v,o){var f={nodes:[],connectors:[]};var p=g;if(!p[this.TRAVERS_VISITED_KEY]){f.nodes.push(p);p[this.TRAVERS_VISITED_KEY]=true;if(d){d(p,false)}}var r=a.clone(p.getLinkedConnectors());var h=this.getConnectors();r.sort(function(j,i){return h.indexOf(j)-h.indexOf(i)});var c=[];for(var u=0,q=r.length;u<q;++u){var b=r[u];var w=p.getLinkedObjsOnConnector(b);if(o){w=a.intersect(w,o)}for(var t=0,s=w.length;t<s;++t){var e=w[t];if(e instanceof Kekule.BaseStructureNode){break}}if(!e){continue}if(!e[this.TRAVERS_VISITED_KEY]){f.nodes.push(e);f.connectors.push(b);e[this.TRAVERS_VISITED_KEY]=true;if(d){d(b,true);d(e,false)}if(v){c.push(e)}else{var x=this._doTravers(d,e,v,o);f.nodes=f.nodes.concat(x.nodes);f.connectors=f.connectors.concat(x.connectors)}}}if(v){for(var u=0,q=c.length;u<q;++u){var m=c[u];var x=this._doTravers(d,m,v,o);f.nodes=f.nodes.concat(x.nodes);f.connectors=f.connectors.concat(x.connectors)}}return f}});Kekule.StructureFragment=Class.create(Kekule.ChemStructureNode,{CLASS_NAME:"Kekule.StructureFragment",initialize:function($super,d,b,c){$super(d,b,c)},doFinalize:function($super){if(this.hasFormula()){this.getFormula().finalize()}if(this.hasCtab()){this.getCtab().finalize()}$super()},initProperties:function(){this.defineProp("formula",{dataType:"Kekule.MolecularFormula",getter:function(b){if(!this.getPropStoreFieldValue("formula")){if(b){this.createFormula()}}return this.getPropStoreFieldValue("formula")},setter:function(c){var b=this.getPropStoreFieldValue("formula");if(b){b.finalize();b=null}if(c){c.setPropValue("parent",this,true);c.addEventListener("change",function(d){this.notifyPropSet("formula",this.getFormula())},this)}this.setPropStoreFieldValue("formula",c)}});this.defineProp("ctab",{dataType:"Kekule.StructureConnectionTable",getter:function(b){if(!this.getPropStoreFieldValue("ctab")){if(b){this.createCtab()}}return this.getPropStoreFieldValue("ctab")},setter:function(c){var b=this.getPropStoreFieldValue("ctab");if(b){b.finalize();b=null}if(c){c.setPropValue("parent",this,true);c.setOwner(this.getOwner());c.addEventListener("propValueSet",function(d){if((d.propName=="nodes")||(d.propName=="anchorNodes")||(d.propName=="connectors")){this.notifyPropSet(d.propName,d.propValue)}},this);c.setEnablePropValueSetEvent(true)}this.setPropStoreFieldValue("ctab",c)}});this.defineProp("nodes",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNodes():[]}});this.defineProp("anchorNodes",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getAnchorNodes():[]}});this.defineProp("connectors",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getConnectors():[]}});this.defineProp("crossConnectors",{dataType:DataType.ARRAY,serializable:false,setter:null,scope:Class.PropertyScope.PUBLIC,getter:function(){var b=[].concat(this.getPropStoreFieldValue("linkedConnectors"));for(var g=0,d=this.getNodeCount();g<d;++g){var h=this.getNodeAt(g);var c=h.getLinkedConnectors()||[];for(var f=0,e=c.length;f<e;++f){if(this.indexOfConnector(c[f])<0){Kekule.ArrayUtils.pushUnique(b,c[f])}}}return b}});this.defineProp("nonHydrogenNodes",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:false,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNonHydrogenNodes():[]}});this.defineProp("nonHydrogenConnectors",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:false,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNonHydrogenConnectors():[]}});this.defineProp("canonicalizationInfo",{dataType:DataType.OBJECT,serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("aromaticRings",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,getter:function(){var b=this.getPropStoreFieldValue("aromaticRings");if(!b){b=[];this.setPropStoreFieldValue("aromaticRings",b)}return b}});this.defineProp("flattenedShadow",{dataType:"Kekule.StructureFragmentShadow",serializable:false,scope:Class.PropertyScope.PRIVATE,getter:function(e){var b=null;if(Kekule.ObjUtils.isUnset(e)){e=true}var c=this.getFlattenedShadowOnSelf();if(c){return null}else{b=this.getPropStoreFieldValue("flattenedShadow");if(!b&&e){b=new Kekule.StructureFragmentShadow(this);var d=b.getShadowFragment();d.unmarshalAllSubFragments(true);this._copyAdditionalInfoToShadowFragment(d,b.getSourceToShadowMap(),b.getShadowToSourceMap());this.setPropStoreFieldValue("flattenedShadow",b)}}return b}});this.defineProp("flattenedShadowOnSelf",{dataType:DataType.BOOL,serializable:false,scope:Class.PropertyScope.PROVATE,setter:null,getter:function(){var b=this.setPropStoreFieldValue("flattenedShadowOnSelf");if(Kekule.ObjUtils.isUnset(b)){b=!this.hasSubFragments();this.setPropStoreFieldValue("flattenedShadowOnSelf",b)}return b}})},getAutoIdPrefix:function(){return"f"},getStructureRelatedPropNames:function($super){return $super().concat(["ctab","formula","nodes","anchorNodes","connectors"])},doCompare:function($super,m,e){var n=$super(m,e);if(!n&&e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){var x=this.hasCtab();var w=m.hasCtab&&m.hasCtab();n=x?(w?0:1):(w?-1:0);if(!n){var q=this.hasFormula();var p=m.hasFormula&&m.hasFormula();n=q?(p?0:1):(p?-1:0)}if(!n&&this.hasCtab()){if((n===0)&&(this.getNonHydrogenNodes&&m.getNonHydrogenNodes)){var v=this.getNonHydrogenNodes();var u=m.getNonHydrogenNodes();n=v.length-u.length;if(n===0){for(var t=0,r=v.length;t<r;++t){n=this.doCompareOnValue(v[t],u[t],e);if(n!==0){break}}}}if((n===0)&&(this.getConnectors&&m.getConnectors)){var g=this.getNonHydrogenConnectors();var f=m.getNonHydrogenConnectors();n=g.length-f.length;if(n===0){for(var t=0,r=g.length;t<r;++t){n=this.doCompareOnValue(g[t],f[t],e);if(n!==0){break}}}}if(n===0){var j=this.getNonHydrogenNodes();var o=m.getNonHydrogenNodes();var h=this.traverse(null,j[j.length-1],true,j);var k=m.traverse(null,o[o.length-1],true,o);for(var t=0,r=h.nodes.length;t<r;++t){var d=h.nodes[t];var s=k.nodes[t];n=this.doCompareOnValue(d,s,e);if(n!==0){break}}if(n===0){for(var t=0,r=h.connectors.length;t<r;++t){var b=h.connectors[t];var c=k.connectors[t];n=this.doCompareOnValue(b,c,e);if(n!==0){break}}}}}}return n},structureChange:function($super,b){this.setPropStoreFieldValue("flattenedShadowOnSelf",null);var c=this.getFlattenedShadow(false);if(c){c.finalize();this.setPropStoreFieldValue("flattenedShadow",null)}$super(b)},clearStructureFlags:function($super){$super();this.setPropStoreFieldValue("canonicalizationInfo",null);this.setPropStoreFieldValue("aromaticRings",[]);for(var d=0,b=this.getChildCount();d<b;++d){var e=this.getChildAt(d);if(e.clearStructureFlags){e.clearStructureFlags()}}},ownerChanged:function($super,b){if(this.hasCtab()){this.getCtab().setOwner(b)}$super(b)},_removeChildObj:function(c){if(this.hasFormula()){var d=this.getFormula();if(d===c){this.removeFormula()}}else{if(this.hasCtab()){var b=this.getCtab();if(b===c){this.removeCtab()}else{if(b.hasChildObj(c)){b.removeChildObj(c)}}}}},isEmpty:function(){var b;b=!this.hasFormula();if(b){b=!this.hasCtab();if(!b){b=this.getCtab().isEmpty()}}return b},isCtabEmpty:function(){return !this.hasCtab()||this.getCtab().isEmpty()},doGetLinkedConnectors:function(){return this.getCrossConnectors()},appendLinkedConnector:function($super,b){var c=this.getCurrConnectableObj();if(c&&c!==this){return c.appendLinkedConnector(b)}else{return $super(b)}},getCurrConnectableObj:function(){var k=(this.getAnchorNodeCount()>0)?this.getAnchorNodes():this.getNodes();if(k.length<=0){return this}else{var b=this.getCrossConnectors();var d=null;var h=null;for(var j=0,f=k.length;j<f;++j){var e=k[j];var c=e.getLinkedConnectors();var g=Kekule.ArrayUtils.intersect(c,b);var m=g.length;if(d===null||d>m){d=m;h=e}}return h}},createCtab:function(){var b=new Kekule.StructureConnectionTable(this.getOwner(),this);this.setCtab(b)},createFormula:function(){var b=new Kekule.MolecularFormula(this);this.setFormula(b)},hasCtab:function(){return(!!this.getPropStoreFieldValue("ctab"))},hasFormula:function(){return(!!this.getPropStoreFieldValue("formula"))},removeFormula:function(){var b=this.getPropStoreFieldValue("formula");if(b){b.finalize();b=null;this.setPropStoreFieldValue("formula",null)}return this},removeCtab:function(){var b=this.getPropStoreFieldValue("ctab");if(b){b.finalize();b=null;this.setPropStoreFieldValue("ctab",null)}return this},getContainerBox:function($super,c,b){if(this.hasCtab()){return this.getCtab().getContainerBox(c,b)}else{return $super(c)}},getNodeById:function(b){return this.hasCtab()?this.getCtab().getNodeById(b):null},getConnectorById:function(b){return this.hasCtab()?this.getCtab().getConnectorById(b):null},getObjectById:function(c){var b=this.getNodeById(c);return b?b:this.getConnectorById(c)},getNodeCount:function(){return this.hasCtab()?this.getCtab().getNodeCount():0},getNodeAt:function(b){return this.hasCtab()?this.getCtab().getNodeAt(b):null},indexOfNode:function(b){return this.hasCtab()?this.getCtab().indexOfNode(b):-1},hasNode:function(c,b){return this.hasCtab()?the.getCtab().hasNode(c,b):null},indexStackOfNode:function(b){return this.hasCtab()?this.getCtab().indexStackOfNode(b):-1},getNodeAtIndexStack:function(b){return this.hasCtab()?this.getCtab().getNodeAtIndexStack(b):null},getDirectChildOfNestedNode:function(b){var d=b.getParent();if(!d){return null}else{if(d===this){return d}else{var c=b;while(d&&(d.getParent)&&(d!==this)){c=d;d=d.getParent()}if(d===this){return c}else{return null}}}},appendNode:function(b){return this.doGetCtab(true).appendNode(b)},insertNodeAt:function(c,b){return this.doGetCtab(true).insertNodeAt(c,b)},removeNodeAt:function(c,b){if(!this.hasCtab()){return null}return this.getCtab().removeNodeAt(c,b)},removeNode:function(c,b){if(!this.hasCtab()){return null}return this.getCtab().removeNode(c,b)},replaceNode:function(c,b){if(!this.hasCtab()){return null}return this.getCtab().replaceNode(c,b)},clearNodes:function(){if(this.hasCtab()){return this.getCtab().clearNodes()}},sortNodes:function(b){if(this.hasCtab()){return this.getCtab().sortNodes(b)}},nodesHasCoord2D:function(b){if(!this.hasCtab()){return false}return this.getCtab().nodesHasCoord2D(b)},nodesHasCoord3D:function(b){if(!this.hasCtab()){return false}return this.getCtab().nodesHasCoord3D(b)},isNodeInAromaticRing:function(e){var f=this.getAromaticRings();for(var d=0,b=f.length;d<b;++d){var c=f[d].nodes;if(c.indexOf(e)>=0){return true}}return false},appendAtom:function(b,c,d,e){return this.doGetCtab(true).appendAtom(b,c,d,e)},getAnchorNodeCount:function(){return this.hasCtab()?this.getCtab().getAnchorNodeCount():0},getAnchorNodeAt:function(b){return this.hasCtab()?this.getCtab().getAnchorNodeAt(b):null},indexOfAnchorNode:function(b){return this.hasCtab()?this.getCtab().indexOfAnchorNode(b):-1},appendAnchorNode:function(b){return this.doGetCtab(true).appendAnchorNode(b)},removeAnchorNodeAt:function(b){if(!this.hasCtab()){return null}return this.getCtab().removeAnchorNodeAt(b)},removeAnchorNode:function(b){if(!this.hasCtab()){return null}return this.getCtab().removeAnchorNode(b)},clearAnchorNodes:function(){if(this.hasCtab()){return this.getCtab().clearAnchorNodes()}},getConnectorCount:function(){return this.hasCtab()?this.getCtab().getConnectorCount():0},getConnectorAt:function(b){return this.hasCtab()?this.getCtab().getConnectorAt(b):null},indexOfConnector:function(b){return this.hasCtab()?this.getCtab().indexOfConnector(b):-1},hasConnector:function(b,c){return this.hasCtab()?this.getCtab().hasConnector(b,c):null},appendConnector:function(b){return this.doGetCtab(true).appendConnector(b)},insertConnectorAt:function(b,c){return this.doGetCtab(true).insertConnectorAt(b,c)},removeConnectorAt:function(c,b){if(!this.hasCtab()){return null}return this.getCtab().removeConnectorAt(c,b)},removeConnector:function(c,b){if(!this.hasCtab()){return null}return this.getCtab().removeConnector(c,b)},clearConnectors:function(){if(this.hasCtab()){return this.getCtab().clearConnectors()}},sortConnectors:function(b){if(this.hasCtab()){return this.getCtab().sortConnectors(b)}},isConnectorInAromaticRing:function(d){var f=this.getAromaticRings();for(var e=0,c=f.length;e<c;++e){var b=f[e].connectors;if(b.indexOf(d)>=0){return true}}return false},appendBond:function(d,c,b){return this.doGetCtab(true).appendBond(d,c,b)},insertBefore:function($super,d,c){var b=-1;if(this.hasCtab()&&(d instanceof Kekule.ChemStructureObject)&&(!c||c instanceof Kekule.ChemStructureObject)){b=this.getCtab().insertBefore(d,c)}if(b<0){b=$super(d,c)}return b},_getObjsNeedToBeCascadeRemoved:function(c,b){if(this.hasCtab()){return this.getCtab()._getObjsNeedToBeCascadeRemoved(c,b)}else{return[]}},removeChildObj:function(d,c,b){if(this.hasCtab()){this.getCtab().removeChildObj(d,c,b)}},removeChild:function($super,b){return this.removeChildObj(b)||$super(b)},hasChildObj:function(b){if(this.hasCtab()){return this.getCtab().hasChildObj(b)}else{return false}},getNextSiblingOfChild:function(b){if(this.hasCtab()){return this.getCtab().getNextSiblingOfChild(b)}else{return null}},getChildCount:function(){if(this.hasCtab()){return this.getCtab().getChildCount()}else{return 0}},getChildAt:function(b){if(this.hasCtab()){return this.getCtab().getChildAt(b)}else{return null}},indexOfChild:function(b){if(this.hasCtab()){return this.getCtab().indexOfChild(b)}else{return -1}},isSubFragment:function(b){return(b.getNodeCount&&(b.getNodeCount()>0))},getSubFragments:function(){return this.hasCtab()?this.getCtab().getSubFragments():[]},hasSubFragments:function(){return this.hasCtab()?this.getCtab().hasSubFragments():false},getLeafNodes:function(){return this.hasCtab()?this.getCtab().getLeafNodes():[]},findDirectChildOfObj:function(b){return this.hasCtab()?this.getCtab().findDirectChildOfObj(b):null},getAllChildConnectors:function(){return this.hasCtab()?this.getCtab().getAllChildConnectors():[]},getAllContainingConnectors:function(){return this.hasCtab()?this.getCtab().getAllContainingConnectors():[]},clear:function(){if(this.hasCtab()){this.setCtab(undefined)}if(this.hasFormula()){this.setFormula(undefined)}},clean:function(b){var c=Object.extend({},Kekule.globalOptions.algorithm.structureClean.structureCleanOptions);c=Object.extend(c,b||{});return this.doClean(c)},doClean:function(c){if(c.hangingChemConnector){for(var d=this.getConnectorCount()-1;d>=0;--d){var f=this.getConnectorAt(d);if(f instanceof Kekule.ChemStructureConnector){if(f.getConnectedObjCount()<2){this.removeConnectorAt(d)}}}}var b=this.getNodeCount();for(var d=b-1;d>=0;--d){var e=this.getNodeAt(d);if(e instanceof Kekule.ChemStructureNode){if(this.isSubFragment(e)&&e.doClean){e.doClean(c)}else{if(c.orphanChemNode){if(e.getLinkedConnectorCount()<1&&b>1){this.removeNodeAt(d)}}}}}return this},calcFormula:function(){if(this.hasCtab()){return this.getCtab().calcFormula()}else{if(this.hasFormula()){return this.getFormula()}else{return null}}},marshalSubFragment:function(g,o){if(this.hasCtab()){this.beginUpdate();try{this.appendNode(o);var q=[];var h=[];var c=[];var e=[];for(var x=0,t=g.length;x<t;++x){var r=g[x];if(this.indexOfNode(r)<0){continue}var y=false;var u=r.getLinkedConnectors();for(var w=0,v=u.length;w<v;++w){var b=u[w];var z=false;var d=b.getConnectedObjs();for(var s=0,p=d.length;s<p;++s){var f=d[s];if(f!=r){if(g.indexOf(f)<0){y=true;z=true}}}if(z){Kekule.ArrayUtils.pushUnique(e,b)}else{Kekule.ArrayUtils.pushUnique(c,b)}}Kekule.ArrayUtils.pushUnique(q,r);if(y){Kekule.ArrayUtils.pushUnique(h,r)}}for(var x=c.length-1;x>=0;--x){this.removeConnector(c[x],true)}for(var x=q.length-1;x>=0;--x){this.removeNode(q[x],true)}o.beginUpdate();try{for(var x=0,t=q.length;x<t;++x){o.appendNode(q[x])}for(var x=0,t=h.length;x<t;++x){o.appendAnchorNode(h[x])}for(var x=0,t=c.length;x<t;++x){o.appendConnector(c[x])}}finally{o.endUpdate()}}finally{this.endUpdate()}return o}else{return null}},unmarshalSubFragment:function(d,b){if(this.hasCtab()){this.beginUpdate();try{d.beginUpdate();try{if(b&&d.unmarshalAllSubFragments){d.unmarshalAllSubFragments(b)}var c=this.getCtab();Kekule.StructureFragment.moveChildBetweenStructFragment(d,this,d.getNodes(),d.getConnectors(),true);d.clear();c.removeNode(d)}finally{d.endUpdate();d.finalize()}}finally{this.endUpdate()}}},unmarshalAllSubFragments:function(d){var c=this.getSubFragments();if(c){for(var e=0,b=c.length;e<b;++e){this.unmarshalSubFragment(c[e],d)}}},recalcCoords:function(){if(this.hasCtab()){this.beginUpdate();try{var k={};var f={};var h=this.getAnchorNodeCount();for(var g=0,e=h;g<e;++g){var c=this.getAnchorNodeAt(g);k=Kekule.CoordUtils.add(k,c.getCoord2D()||{});f=Kekule.CoordUtils.add(f,c.getCoord3D()||{})}var j=Kekule.ObjUtils.notUnset;var d=(j(k.x)||j(k.y));var n=(j(f.x)||j(f.y)||j(f.z));if(d){var b=Kekule.CoordUtils.substract({},k);this.setCoord2D(Kekule.CoordUtils.substract(this.fetchCoord2D(),b))}if(n){var m=Kekule.CoordUtils.substract({},f);this.setCoord3D(Kekule.CoordUtils.substract(this.fetchCoord3D(),m))}for(var g=0,e=this.getNodeCount();g<e;++g){var c=this.getNodeAt(g);if(d){c.setCoord2D(Kekule.CoordUtils.add(c.fetchCoord2D(),b))}if(n){c.setCoord3D(Kekule.CoordUtils.add(c.fetchCoord3D(),m))}}}finally{this.endUpdate()}}},_copyAdditionalInfoToShadowFragment:function(s,p,r){var m=this;var g=m.getAromaticRings();if(g&&g.length){var q=[];for(var n=0,e=g.length;n<e;++n){var o=g[n];var d=[],c=[];for(var h=0,f=o.nodes.length;h<f;++h){var b=p.get(o.nodes[h]);if(b){d.push(b)}}for(var h=0,f=o.connectors.length;h<f;++h){var b=p.get(o.connectors[h]);if(b){c.push(b)}}q.push({nodes:d,connectors:c})}s.setAromaticRings(q)}},getFlattenedShadowFragment:function(b){if(this.getFlattenedShadowOnSelf()){return this}else{var c=this.getFlattenedShadow(b);return c?c.getShadowFragment():null}},getFlatternedShadowShadowObj:function(b,c){if(this.getFlattenedShadowOnSelf()){return b}else{var d=this.getFlattenedShadow(c);return d?d.getShadowObj(b):null}},getFlatternedShadowSourceObj:function(c,b){if(this.getFlattenedShadowOnSelf()){return c}else{var d=this.getFlattenedShadow(b);return d?d.getSourceObj(c):null}},getFlatternedShadowShadowObjs:function(c,f){if(this.getFlattenedShadowOnSelf()){return c}else{var g=this.getFlattenedShadow(f);var b=[];if(g){for(var e=0,d=c.length;e<d;++e){b.push(g.getShadowObj(c[e]))}}return b}},getFlatternedShadowSourceObjs:function(c,f){if(this.getFlattenedShadowOnSelf()){return c}else{var g=this.getFlattenedShadow(f);var b=[];if(g){for(var e=0,d=c.length;e<d;++e){b.push(g.getSourceObj(c[e]))}}return b}},traverse:function(e,c,d,b){if(this.hasCtab()){return this.getCtab().traverse(e,c,d)}else{return null}}});Kekule.StructureFragment.moveChildBetweenStructFragment=function(x,m,A,f,d){var y=Kekule.CoordUtils;x.beginUpdate();m.beginUpdate();var b=x.getAnchorNodes();try{var k=x.getAbsCoord2D();var t=x.getAbsCoord3D();var z=m.getAbsCoord2D();var j=m.getAbsCoord3D();var o=y.substract(k,z);var w=y.substract(t,j);var p=Kekule.ArrayUtils.clone(A);var s=Kekule.ArrayUtils.clone(f);for(var u=0,r=p.length;u<r;++u){var q=p[u];var h=x.indexOfNode(q);if(h>=0){x.removeNodeAt(h,true);var v=q.getCoord2D();if(v){var e=y.add(v,o);q.setCoord2D(e)}var g=q.getCoord3D();if(g){var n=y.add(g,w);q.setCoord2D(n)}m.appendNode(q);if(b.indexOf(q)>=0){x.removeAnchorNode(q);if(!d){m.appendAnchorNode(q)}}}}for(var u=0,r=s.length;u<r;++u){var c=s[u];var h=x.indexOfConnector(c);if(h>=0){x.removeConnectorAt(h,true);m.appendConnector(c)}}}finally{m.endUpdate();x.endUpdate()}};Kekule.StructureFragmentShadow=Class.create(ObjectEx,{CLASS_NAME:"Kekule.StructureFragmentShadow",initialize:function($super,c){if(!c){Kekule.error(Kekule.$L("ErrorMsg.SOURCE_FRAGMENT_NOT_SET"));return}$super();this.setPropStoreFieldValue("shadowToSourceMap",new Kekule.MapEx());this.setPropStoreFieldValue("sourceToShadowMap",new Kekule.MapEx());var b=this._createShadowFragment(c,this.getSourceToShadowMap(),this.getShadowToSourceMap());this.setPropStoreFieldValue("shadowFragment",b)},doFinalize:function($super){this.getShadowToSourceMap().finalize();this.getSourceToShadowMap().finalize();this.getShadowFragment().finalize();this.setPropStoreFieldValue("shadowToSourceMap",null);this.setPropStoreFieldValue("sourceToShadowMap",null);this.setPropStoreFieldValue("shadowFragment",null);$super()},initProperties:function(){this.defineProp("shadowFragment",{dataType:"Kekule.StructureFragment",setter:null});this.defineProp("sourceToShadowMap",{dataType:"Kekule.MapEx",setter:null});this.defineProp("shadowToSourceMap",{dataType:"Kekule.MapEx",setter:null})},_createShadowFragment:function(d,c,e){var b=d.clone();this._mapFragmentChildren(d,b,c,e);return b},_mapFragmentChildren:function(h,j,c,g){for(var e=0,b=h.getChildCount();e<b;++e){var d=h.getChildAt(e);var f=j.getChildAt(e);c.set(d,f);g.set(f,d);if(d.getChildCount&&f.getChildCount){this._mapFragmentChildren(d,f,c,g)}}},getShadowObj:function(b){return this.getSourceToShadowMap().get(b)},getSourceObj:function(b){return this.getShadowToSourceMap().get(b)}});Kekule.SubGroup=Class.create(Kekule.StructureFragment,{CLASS_NAME:"Kekule.SubGroup",initialize:function($super,f,c,b,d,e){$super(f,d,e);this.setPropStoreFieldValue("abbr",c);this.setPropStoreFieldValue("name",b)},initProperties:function(){this.defineProp("abbr",{dataType:DataType.STRING});this.defineProp("formulaText",{dataType:DataType.STRING});this.defineProp("name",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"g"},doPropChanged:function($super,b,c){if(b=="anchorNodes"){this.recalcCoords()}return $super(b,c)},getLabel:function(){return Kekule.ChemStructureNodeLabels.SUBGROUP}});Kekule.RGroup=Kekule.SubGroup;Kekule.Molecule=Class.create(Kekule.StructureFragment,{CLASS_NAME:"Kekule.Molecule",initialize:function($super,d,b,c){$super(d);this.setPropStoreFieldValue("name",b);if(c){this.setCtab(new Kekule.StructureConnectionTable())}},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"m"}});Kekule.BaseStructureConnector=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.BaseStructureConnector",initialize:function($super,c,b){$super(c);this.setConnectedObjs(b||[])},initProperties:function(){this.defineProp("connectedObjs",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLISHED,setter:function(e){var g=this.getPropStoreFieldValue("connectedObjs");if(!g){this.setPropStoreFieldValue("connectedObjs",[]);g=this.getPropStoreFieldValue("connectedObjs")}for(var d=0,b=g.length;d<b;++d){g[d].removeLinkedConnector(this)}if(e){for(var d=0,b=e.length;d<b;++d){this.assertConnectedObjLegal(e[d])}for(var d=0,b=e.length;d<b;++d){var f=e[d];var c=f.getCurrConnectableObj?f.getCurrConnectableObj():f;Kekule.ArrayUtils.pushUnique(g,c)}}else{this.setPropStoreFieldValue("connectedObjs",[])}g=this.getPropStoreFieldValue("connectedObjs");for(var d=0,b=g.length;d<b;++d){g[d].appendLinkedConnector(this)}this.notifyConnectedObjsChanged()}})},getAutoIdPrefix:function(){return"c"},getStructureRelatedPropNames:function($super){return $super().concat(["connectedObjs"])},doCompare:function($super,e,c){var b=$super(e,c);if(!b&&c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(c,"connectedObjCount")){var f=this.getConnectedObjCount();var d=e.getConnectedObjCount&&e.getConnectedObjCount();b=this.doCompareOnValue(f,d,c)}}return b},notifyConnectedObjsChanged:function(){this.notifyPropSet("connectedObjs",this.getPropStoreFieldValue("connectedObjs"))},assertConnectedObjLegal:function(b){if((!b)||(!b.getOwner)){Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.UNABLE_ADD_MISTYPED_NODE"):"Unable to link mistyped node to connector")}else{if(b.getOwner()&&b.getOwner()!=this.getOwner()){Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.UNABLE_ADD_DIFF_OWNER_OBJ"):"Object with different owner can not be linked to connector");return false}else{return true}}},connectedObjAdded:function(b){this.notifyConnectedObjsChanged()},getConnectedObjCount:function(){return this.getConnectedObjs().length},indexOfConnectedObj:function(b){return this.getConnectedObjs().indexOf(b)},getConnectedObjAt:function(b){return this.getConnectedObjs()[b]},setConnectedObjAt:function(b,d){this.assertConnectedObjLegal(d);var c=this.getConnectedObjs()[b];if(c){c.removeLinkedConnector(this)}this.insertConnectedObjAt(d,b);this.connectedObjAdded(d)},appendConnectedObj:function(d){this.assertConnectedObjLegal(d);var c=d.getCurrConnectableObj?d.getCurrConnectableObj():d;var b=this._doAppendConnectedObj(c);if(c){c.appendLinkedConnector(this)}return b},_doAppendConnectedObj:function(c){var b=Kekule.ArrayUtils.pushUniqueEx(this.getConnectedObjs(),c);if(b.isPushed){this.connectedObjAdded(c)}return b.index},insertConnectedObjAt:function(e,c){this.assertConnectedObjLegal(e);var b=e.getCurrConnectableObj?e.getCurrConnectableObj():e;var d=this.indexOfConnectedObj(b);var f=this.getConnectedObjs();if(d>=0){f.splice(d,1);f.splice(c,0,b);this.notifyConnectedObjsChanged()}else{f.splice(c,0,b);if(b){b.appendLinkedConnector(this)}this.connectedObjAdded(b)}},removeConnectedObjAt:function(b){var c=this.getConnectedObjs()[b];if(c){this._doRemoveConnectedObjAt(b);c._doRemoveLinkedConnectorAt(c.indexOfLinkedConnector(this));this.notifyConnectedObjsChanged()}},_doRemoveConnectedObjAt:function(b){this.getConnectedObjs().splice(b,1)},removeConnectedObj:function(c){var b=this.getConnectedObjs().indexOf(c);if(b>=0){this.removeConnectedObjAt(b)}},replaceConnectedObj:function(b,c){var d=this.indexOfConnectedObj(b);if(d>=0){this.setConnectedObjAt(d,c)}},clearConnectedObjs:function(){this.setConnectedObjs([])},hasConnectedObj:function(b){return(this.getConnectedObjs().indexOf(b)>=0)},isConnectingWithObj:function(b){return this.hasConnectedObj(b)},sortConnectedObjs:function(b){this.getConnectedObjs().sort(b)},reverseConnectedObjOrder:function(){this.setPropStoreFieldValue("connectedObjs",Kekule.ArrayUtils.reverse(this.getConnectedObjs()));this.notifyConnectedObjsChanged()},removeThisFromConnectedObjs:function(){for(var b=this.getConnectedObjCount()-1;b>=0;--b){var c=this.getConnectedObjAt(b);c.removeLinkedConnector(this)}},getConnectedSiblings:function(){var j=this.getConnectedObjs();var b=[];var f=this.getParent();var e=function(k){if(k.getParent){var i=k.getParent();if(i===f){return i}else{return e(i)}}else{return k}};for(var d=0,c=j.length;d<c;++d){var g=j[d];if(!g.getParent||(g.getParent()===f)){b.push(g)}else{var h=e(g);if(h){b.push(h)}}}return b},isConnectingConnector:function(){for(var c=0,b=this.getConnectedObjCount();c<b;++c){var d=this.getConnectedObjAt(c);if(d instanceof Kekule.ChemStructureConnector){return true}}return false}});Kekule.ChemStructureConnector=Class.create(Kekule.BaseStructureConnector,{CLASS_NAME:"Kekule.ChemStructureConnector",initProperties:function(){this.defineProp("parity",{dataType:DataType.INT});this.defineProp("connectedChemNodes",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){var b=[];for(var d=0,c=this.getConnectedObjCount();d<c;++d){var e=this.getConnectedObjAt(d);if(e instanceof Kekule.ChemStructureNode){b.push(e)}}return b}})},doCompare:function($super,e,c){var b=$super(e,c);if(!b&&c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(c,"stereo")){var f=this.getParity()||Kekule.StereoParity.UNKNOWN;var d=(e.getParity&&e.getParity())||Kekule.StereoParity.UNKNOWN;b=this.doCompareOnValue(f,d,c)}}return b},clearStructureFlags:function(){this.setParity(Kekule.StereoParity.NONE)},getConnectedChemNodeCount:function(){return this.getConnectedChemNodes().length},getConnectedNonHydrogenObjs:function(){var b=[];var f=this.getConnectedObjs();for(var d=0,c=f.length;d<c;++d){var e=f[d];if(!e.isHydrogenAtom||!e.isHydrogenAtom()){b.push(e)}}return b},isNormalConnectorToHydrogen:function(){return this.getConnectedNonHydrogenObjs().length<=1}});Kekule.BondStereo={NONE:0,UP:1,UP_INVERTED:2,DOWN:3,DOWN_INVERTED:4,UP_OR_DOWN:8,UP_OR_DOWN_INVERTED:9,CLOSER:10,E_OR_Z:20,E:21,Z:22,E_Z_BY_COORDINATES:23,CIS_OR_TRANS:30,CIS:31,TRANS:32,getInvertedDirection:function(c){var b=Kekule.BondStereo;switch(c){case b.UP:return b.UP_INVERTED;case b.UP_INVERTED:return b.UP;case b.DOWN:return b.DOWN_INVERTED;case b.DOWN_INVERTED:return b.DOWN;case b.UP_OR_DOWN:return b.UP_OR_DOWN_INVERTED;default:return c}}};Kekule.Bond=Class.create(Kekule.ChemStructureConnector,{CLASS_NAME:"Kekule.Bond",initialize:function($super,f,d,c,e,b){$super(f,d||[]);if(c||e||b){this.setBondForm(Kekule.BondFormFactory.getBondForm(c,e,b))}},initProperties:function(){this.defineProp("bondForm",{dataType:"Kekule.BondForm",serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("bondType",{dataType:DataType.STRING,enumSource:Kekule.BondType,getter:function(){var b=this.getBondForm();return b?b.getBondType():Kekule.BondType.DEFAULT},setter:function(b){this.changeBondForm(this.getBondOrder(),Kekule.ElectronSet.UNSET_ELECTRONCOUNT,b)}});this.defineProp("bondOrder",{dataType:DataType.INT,enumSource:Kekule.BondOrder,getter:function(){var b=this.getBondForm();return b?b.getBondOrder():Kekule.BondOrder.UNSET},setter:function(b){this.changeBondForm(b,Kekule.ElectronSet.UNSET_ELECTRONCOUNT,this.getBondType())}});this.defineProp("bondValence",{dataType:DataType.INT,serializable:false,getter:function(){var b=this.getBondForm();return b?b.getBondValence():0},setter:null});this.defineProp("electronCount",{dataType:DataType.FLOAT,getter:function(){if(this.isAromatic()){return 3}var b=this.getBondForm();return b?b.getElectronCount():Kekule.ElectronSet.UNSET_ELECTRONCOUNT},setter:function(c){var b=this.getBondOrder();this.changeBondForm(b,c,this.getBondType())}});this.defineProp("stereo",{dataType:DataType.INT,enumSource:Kekule.BondStereo,defaultValue:Kekule.BondStereo.NONE});this.defineProp("isInAromaticRing",{dataType:DataType.BOOL,setter:null,getter:function(){var b=false;var c=this.getParent();if(c&&c.isConnectorInAromaticRing){return c.isConnectorInAromaticRing(this)}else{return false}}})},initPropValues:function($super){$super();this.setPropStoreFieldValue("stereo",Kekule.BondStereo.NONE)},getAutoIdPrefix:function(){return"b"},getStructureRelatedPropNames:function($super){return $super().concat(["bondForm","stereo"])},clearStructureFlags:function(){this.setPropStoreFieldValue("isInAromaticRing",null)},doGetParity:function($super){if(this.isDoubleBond()){return $super()}else{return null}},doGetComparisonPropNames:function($super,c){var b=$super(c);if(c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(c,"bondType")){b.push("bondType")}}return b},doCompare:function($super,g,e){var c=$super(g,e);if(!c&&e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(e,"connectedObjCount")){var h=this.getConnectedObjCount();var f=g.getConnectedObjCount&&g.getConnectedObjCount();c=this.doCompareOnValue(h,f,e)}if(!c&&this._getComparisonOptionFlagValue(e,"bondOrder")){var d=Math.round(this.getElectronCount());var b=Math.round(g.getElectronCount());c=this.doCompareOnValue(d,b,e)}}return c},changeBondForm:function(c,d,b){this.setBondForm(Kekule.BondFormFactory.getBondForm(c,d,b))},canInvertBondDirection:function(){var b=Kekule.BondType;var c=this.getBondType();return[b.COVALENT,b.IONIC,b.METALLIC,b.HYDROGEN,b.UNKNOWN].indexOf(c)>=0},invertBondDirection:function(){this.setStereo(Kekule.BondStereo.getInvertedDirection(this.getStereo()))},reverseConnectedObjOrder:function($super){if(this.canInvertBondDirection()){$super();this.invertBondDirection()}else{}},normalizeDirection:function(){var c=Kekule.BondStereo;var b=[c.UP_INVERTED,c.DOWN_INVERTED,c.UP_OR_DOWN_INVERTED];var e=this.getBondStereo();if(b.indexOf(e)>=0){this.reverseConnectedObjOrder()}},isSingleBond:function(){return(this.getBondType()===Kekule.BondType.COVALENT)&&(this.getBondOrder()===Kekule.BondOrder.SINGLE)&&(!this.getIsInAromaticRing())},isDoubleBond:function(){return(this.getBondType()===Kekule.BondType.COVALENT)&&(this.getBondOrder()===Kekule.BondOrder.DOUBLE)&&(!this.getIsInAromaticRing())},isTripleBond:function(){return(this.getBondType()===Kekule.BondType.COVALENT)&&(this.getBondOrder()===Kekule.BondOrder.TRIPLE)},isAromatic:function(){return(!!this.getIsInAromaticRing()||(this.getBondOrder()===Kekule.BondOrder.EXPLICIT_AROMATIC))&&(this.getBondType()===Kekule.BondType.COVALENT)},isBondBetween:function(f,e){var j=this.getConnectedObjs();if(j.length!==2){return false}var d,c;for(var g=0,b=j.length;g<b;++g){var h=j[g];if(h instanceof Kekule.Atom){if(h.isElement(f)){d=true}else{if(h.isElement(e)){c=true}}if(d&&c){return true}}}return false}});Kekule.ChemStructureObjectGroup=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.ChemStructureObjectGroup",ITEM_BASE_CLASSES:["Kekule.ChemStructureObject","Kekule.ChemStructureObjectGroup"],initialize:function($super,b){$super(b);this.setPropStoreFieldValue("items",[]);this.setPropStoreFieldValue("raiseExceptionOnTypeMismatch",[])},initProperties:function(){this.defineProp("items",{dataType:DataType.ARRAY});this.defineProp("raiseExceptionOnTypeMismatch",{dataType:DataType.BOOL,defaultValue:true,scope:Class.PropertyScope.PUBLIC})},getAutoIdPrefix:function(){return"sg"},getStructureRelatedPropNames:function($super){return $super().concat(["items"])},doGetComparisonPropNames:function($super,c){var b=$super(c);if(c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){b.push("items")}return b},ownerChanged:function($super,c){var d=this.getItems();for(var e=0,b=d.length;e<b;++e){var f=d[e].obj;if(f&&f.setOwner){f.setOwner(c)}}$super(c)},_removeChildObj:function(c){var b=this.indexOfObj(c);if(b<0){b=this.indexOfItem(c)}if(b>=0){this.removeObjAt(b)}},getObjectBaseClasses:function(){return this.getPrototype().ITEM_BASE_CLASSES},ensureItemClass:function(e){var d=this.getObjectBaseClasses();if(d.length>0){for(var c=0,b=d.length;c<b;++c){if(e instanceof ClassEx.findClass(d[c])){return true}}if(this.getRaiseExceptionOnTypeMismatch()){var f=Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.CHEMSTRUCTUREOBJECTGROUP_ITEMCLASS_MISMATCH"):"Mismatched group item class";Kekule.raise(f)}return false}else{return true}},notifyItemsChanged:function(){this.notifyPropSet("items",this.getPropStoreFieldValue("items"))},indexOfItem:function(b){return this.getItems().indexOf(b)},indexOfObj:function(e){var c=this.getItems();for(var d=0,b=c.length;d<b;++d){if(c[d].obj==e){return d}}return -1},hasObj:function(b){return this.indexOfObj(b)>=0},setAttributesAt:function(d,c){var g=this.getItems()[d];if(g){var f=Kekule.ObjUtils.getOwnedFieldNames(c);for(var e=0,b=f.length;e<b;++e){g[f[e]]=c[f[e]]}}},getItemCount:function(){return this.getItems().length},getItemAt:function(b){return this.getItems()[b]},appendItem:function(b){this.getItems().push(b);return this},insertItem:function(c,b){return Kekule.ArrayUtils.insertUniqueEx(this.getItems(),c,b).index},removeItemAt:function(b){var c=this.getItems()[b];if(c){this.getItems().splice(b,1);this.notifyItemsChanged()}},removeItem:function(c){var b=this.getItems().indexOf(c);if(b>=0){this.removeItemAt(b)}},getObjAt:function(b){var c=this.getItemAt(b);return c?c.obj:null},insertObj:function(f,d,c){if(!f){return}if(this.indexOfObj(f)>=0){}else{if(this.ensureItemClass(f)){var e={obj:f};this.beginUpdate();try{var b=this.insertItem(e,d);if(c){this.setAttributesAt(b,c)}this.notifyItemsChanged()}finally{this.endUpdate()}return b}}},appendObj:function(c,b){return this.insertObj(c,null,b)},removeObjAt:function(b){var c=this.getItems()[b];if(c){this.getItems().splice(b,1);this.notifyItemsChanged()}},removeObj:function(c){var b=this.indexOfObj(c);if(b>=0){this.removeObjAt(b)}},getAllObjs:function(){var b=[];for(var d=0,c=this.getItemCount();d<c;++d){b.push(this.getObjAt(d))}return b},getChildCount:function(){return this.getItemCount()},getChildAt:function(b){return this.getObjAt(b)},indexOfChild:function(c){var b=this.indexOfObj(c);if(b<0){b=this.indexOfItem(c)}return b},getNextSiblingOfChild:function(c){var b=this.indexOfItem(c);if(b<0){b=this.indexOfObj(c)}return(b>=0)?this.getChildAt(index+1):null},appendChild:function(b){if(b instanceof Kekule.ChemObject){return this.appendObj(b)}else{return this.appendItem(b)}},insertChild:function(c,b){if(c instanceof Kekule.ChemObject){return this.insertObj(c,b)}else{return this.insertItem(c,b)}},insertBefore:function(c,b){var d=this.indexOfItem(b);if(d<0){d=this.indexOfObj(b)}return this.insertChild(c,d)},removeChildAt:function(b){return this.removeItemAt(b)},removeChild:function($super,d){var b;var c=this.indexOfItem(d);if(c<=0){c=this.indexOfObj(d)}if(c>=0){b=this.removeItemAt(c)}return b||$super(d)}});Kekule.StructureFragmentGroup=Class.create(Kekule.ChemStructureObjectGroup,{CLASS_NAME:"Kekule.ChemStructureObjectGroup",ITEM_BASE_CLASSES:["Kekule.StructureFragment","Kekule.StructureFragmentGroup"]});Kekule.MoleculeGroup=Class.create(Kekule.ChemStructureObjectGroup,{CLASS_NAME:"Kekule.MoleculeGroup",ITEM_BASE_CLASSES:["Kekule.Molecule","Kekule.MoleculeGroup"]});Kekule.CompositeMolecule=Class.create(Kekule.Molecule,{CLASS_NAME:"Kekule.CompositeMolecule",initialize:function($super,c,b){$super(c,b)},initProperties:function(){this.defineProp("subMolecules",{dataType:"Kekule.MoleculeGroup",getter:function(){if(!this.getPropStoreFieldValue("subMolecules")){this.setPropStoreFieldValue("subMolecules",new Kekule.MoleculeGroup())}return this.getPropStoreFieldValue("subMolecules")}})},doGetComparisonPropNames:function($super,c){var b=$super(c);if(c.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){b.push("subMolecules")}return b},ownerChanged:function($super,b){var c=this.getPropStoreFieldValue("subMolecules");if(c){c.setOwner(b)}$super(b)},getSubMoleculeCount:function(){var b=this.getPropStoreFieldValue("subMolecules");return b?b.length:0},hasCtab:function(){return false},hasFormula:function(){return false},getAllContainingConnectors:function(){var g=this.getSubMolecules();var c=[];for(var f=0,e=g.getItemCount();f<e;++f){var b=g.getObjAt(f);if(b.getAllContainingConnectors){var d=b.getAllContainingConnectors();if(d&&d.length){c=c.concat(d)}}}return c},getContainerBox:function(g){var b=null;var e=this.getPropStoreFieldValue("subMolecules");if(e){for(var d=0,c=e.getItemCount();d<c;++d){var h=e.getObjAt(d);var f=h.getContainerBox(g);if(f){if(!b){b=Kekule.BoxUtils.clone(f)}else{b=Kekule.BoxUtils.getContainerBox(b,f)}}}}return b},doGetCtab:function(){return null},doSetCtab:function(){},doGetFormula:function(){return null},doSetFormula:function(){},getChildCount:function(){return this.getSubMolecules().getChildCount()},getChildAt:function(b){return this.getSubMolecules().getChildAt(b)},indexOfChild:function(b){return this.getSubMolecules().indexOfChild(b)},getNextSiblingOfChild:function(b){return this.getSubMolecules().getNextSiblingOfChild(b)},appendChild:function($super,b){return $super(b)},insertChild:function(c,b){return this.getSubMolecules().insertChild(c,b)},insertBefore:function($super,c,b){if(c instanceof Kekule.StructureFragment){return this.getSubMolecules().insertBefore(c,b)}else{return $super(c,b)}},removeChildAt:function(b){return this.getSubMolecules().removeChildAt(b)},removeChild:function($super,b){return this.getSubMolecules().removeChild(b)||$super(b)}});Kekule.MoleculeList=Class.create(Kekule.ChemObjList,{CLASS_NAME:"Kekule.MoleculeList",initialize:function($super,b){$super(b,Kekule.Molecule)}});Kekule.ChemStructureNodeLabels={ENABLE_ISOTOPE_ALIAS:true,UNSET_ELEMENT:"?",DUMMY_ATOM:"Du",HETERO_ATOM:"Q",ANY_ATOM:"A",CUSTOM_ATOM:"@",VARIABLE_ATOM:"L",SUBGROUP:"R",ISO_LIST_LEADING_BRACKET:"[",ISO_LIST_TAILING_BRACKET:"]",ISO_LIST_DELIMITER:",",ISO_LIST_DISALLOW_PREFIX:"NOT"};Kekule.ChemStructureNodeFactory={CANDIDATE_CLASSES:[Kekule.SubGroup,Kekule.VariableAtom,Kekule.Pseudoatom],getClassByLabel:function(n,b){if(b===undefined){b=Kekule.Pseudoatom}var g=Kekule.ChemStructureNodeLabels;var h=[[g.SUBGROUP],[g.VARIABLE_ATOM],[g.DUMMY_ATOM,g.HETERO_ATOM,g.ANY_ATOM,g.CUSTOM_ATOM]];var d=Kekule.ChemStructureNodeFactory.CANDIDATE_CLASSES;var m;for(var f=0,e=d.length;f<e;++f){var k=d[f];var j=h[f];if(j.indexOf(n)>=0){m=k;break}}if(!m){if(Kekule.IsotopesDataUtil.isIsotopeIdAvailable(n)){m=Kekule.Atom}else{m=b}}return m},createByLabel:function(c){var d=Kekule.ChemStructureNodeFactory.getClassByLabel(c);var b=new d();if(b instanceof Kekule.Pseudoatom){b.setSymbol(c)}else{if(b instanceof Kekule.Atom){b.setIsotopeId(c)}}return b}}})();Kekule.ChemStructureBuilder=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ChemStructureBuilder",initialize:function($super,a){$super();if(a){this.setTarget(a)}},initProperties:function(){this.defineProp("target",{dataType:"Kekule.StructureFragment"})},setNodeCoord:function(){var c=Array.prototype.slice.call(arguments);var e=c.shift();var f=c;for(var d=0,b=f.length;(d<b)&&(d<2);++d){var g=f[d];if(g.z!==undefined){e.setCoordOfMode(g,Kekule.CoordMode.COORD3D)}else{e.setCoordOfMode(g,Kekule.CoordMode.COORD2D)}}},createNode:function(){var c=Array.prototype.slice.call(arguments);var d=c.shift();var f=c.shift();var e=c;var b=new d(f);this.setNodeCoord(b,e);this.appendNode(b);return b},createConnector:function(b,d,c){var a=new b(d);a.setConnectedObjs(c);return a},appendNode:function(a){if(a&&this.getTarget()){return this.getTarget().appendNode(a)}else{return null}},appendConnector:function(a){if(a&&this.getTarget()){return this.getTarget().appendConnector(a)}else{return null}},createAtom:function(){var e=Array.prototype.slice.call(arguments);var f=e.shift();var c=e.shift();var d=e.shift();var b=new Kekule.Atom(f,c,d);e.unshift(b);this.setNodeCoord.apply(this,e);this.appendNode(b);return b},createBond:function(f,e,c,d,b){var a=new Kekule.Bond(f,e,c);a.changeBondForm(c,null,b);if(d){a.setStereo(d)}this.appendConnector(a);return a},deleteNode:function(){},marshalSubGroup:function(a,d){var c=this.getTarget();if(c&&c.hasCtab()){var b=new Kekule.SubGroup(d);c.marshalSubFragment(a,b);return b}else{return null}}});Kekule.ReactionComponent={REACTANT:"reactant",PRODUCT:"product",SUBSTANCE:"substance",CONDITION:"condition"};Kekule.ReactionRole={REAGENT:"reagent",CATALYST:"catalyst",SOLVENT:"solvent",TEMPERATURE:"temperature",DURATION:"duration"};Kekule.ReactionDirection={FORWARD:1,BACKWARD:-1,BIDIRECTION:0};Kekule.Reaction=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Reaction",initialize:function($super,a){$super(a);this.setDirection(Kekule.ReactionDirection.FORWARD)},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING});this.defineProp("title",{dataType:DataType.STRING});this.defineProp("reactionType",{dataType:DataType.STRING});this.defineProp("yield",{dataType:DataType.FLOAT});this.defineProp("direction",{dataType:DataType.INT,defaultValue:Kekule.ReactionDirection.FORWARD,enumSource:Kekule.ReactionDirection});this.defineProp("reactants",{dataType:DataType.ARRAY,setter:null,getter:function(b){var a=this.getPropStoreFieldValue("reactants");if((!a)&&b){a=[];this.setPropStoreFieldValue("reactants",a)}return a}});this.defineProp("products",{dataType:DataType.ARRAY,setter:null,getter:function(b){var a=this.getPropStoreFieldValue("products");if((!a)&&b){a=[];this.setPropStoreFieldValue("products",a)}return a}});this.defineProp("substances",{dataType:DataType.ARRAY,setter:null,getter:function(b){var a=this.getPropStoreFieldValue("substances");if((!a)&&b){a=[];this.setPropStoreFieldValue("substances",a)}return a}});this.defineProp("conditions",{dataType:DataType.ARRAY,setter:null,getter:function(b){var a=this.getPropStoreFieldValue("conditions");if((!a)&&b){a=[];this.setPropStoreFieldValue("conditions",a)}return a}})},ownerChanged:function($super,f){var g=["reactants","products","substances","conditions"];for(var e=0,b=g.length;e<b;++e){var h=g[e];var m=this.getComponentArray(h);if(m){for(var d=0,c=m.length;d<c;++d){var n=m[d].item;if(n.setOwner){n.setOwner(f)}}}}$super(f)},assertAddingMolecule:function(a){if(!(a instanceof Kekule.Molecule)){Kekule.chemError(Kekule.$L("ErrorMsg.UNABLE_ADD_NONMOLECULE_MAP"))}},notifyReactantsChange:function(){this.notifyPropSet("reactants",this.getPropStoreFieldValue("reactants"))},notifyProductsChange:function(){this.notifyPropSet("products",this.getPropStoreFieldValue("products"))},notifySubstancesChange:function(){this.notifyPropSet("substances",this.getPropStoreFieldValue("substances"))},notifyConditionsChange:function(){this.notifyPropSet("conditions",this.getPropStoreFieldValue("conditions"))},notifyComponentChange:function(a){var b=this.componentToPropName(a);if(b){this.notifyPropSet(b,this.getPropStoreFieldValue(b))}},componentToPropName:function(a){return a+"s"},getComponentArray:function(a,c){var b=this.componentToPropName(a);if(b){switch(b){case"reactants":return this.doGetReactants(c);break;case"products":return this.doGetProducts(c);break;case"substances":return this.doGetSubstances(c);break;case"conditions":return this.doGetConditions(c);break;default:return null}}else{return null}},getComponentItemCount:function(c){var b=this.getComponentArray(c);return b?b.length:0},getMapAt:function(d,c){var b=this.getComponentArray(d);return b?b[c]:null},getMapItemAt:function(b,a){var c=this.getMapAt(b,a);return c?c.item:null},indexOfMap:function(c,d){var b=this.getComponentArray(c);return b?b.indexOf(d):-1},indexOfItem:function(d,f,g){var c=this.getComponentArray(d);if(c){for(var e=0,b=c.length;e<b;++e){if(c[e].item==f){if(typeof(g)==="undefined"){return e}else{if(g===c[e].role){return e}}}}}return -1},appendMap:function(a,c){if((a==Kekule.ReactionComponent.PRODUCT)||(a==Kekule.ReactionComponent.REACTANT)){this.assertAddingMolecule(c.item)}var b=Kekule.ArrayUtils.pushUniqueEx(this.getComponentArray(a,true),c);if(b.isPushed){this.notifyComponentChange(a)}return b.index},appendItem:function(b,e,g,c){var a=this.indexOfItem(b,e,g);if(a<0){if((b==Kekule.ReactionComponent.PRODUCT)||(b==Kekule.ReactionComponent.REACTANT)){this.assertAddingMolecule(e)}var f=Kekule.RoleMapUtils.createMap(e,g);if(c){Object.extend(f,c)}var d=Kekule.ArrayUtils.pushUniqueEx(this.getComponentArray(b,true),f);this.notifyComponentChange(b);return d.index}else{return a}},removeMapAt:function(d,c){var e=null;var b=this.getComponentArray(d);if(b){e=Kekule.ArrayUtils.removeAt(b,c);if(e){this.notifyComponentChange(d)}}return e},removeMap:function(c,e){var d=null;var b=this.getComponentArray(c);if(b){d=Kekule.ArrayUtils.remove(b,e);if(d){this.notifyComponentChange(c)}}return d},removeItem:function(b,c,d){var a=this.indexOfItem(b,c,d);if(a>=0){return this.removeMapAt(b,a)}else{return null}},clearComponent:function(c){var b=this.getComponentArray(c);b=[];this.notifyComponentChange(c)},getReactantCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.REACTANT)},getProductCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.PRODUCT)},getSubstancesCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.SUBSTANCE)},getConditionCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.CONDITION)},getReactantMapAt:function(a){return this.getMapAt(Kekule.ReactionComponent.REACTANT,a)},getProductMapAt:function(a){return this.getMapAt(Kekule.ReactionComponent.PRODUCT,a)},getSubstanceMapAt:function(a){return this.getMapAt(Kekule.ReactionComponent.SUBSTANCE,a)},getConditionMapAt:function(a){return this.getMapAt(Kekule.ReactionComponent.CONDITION,a)},getReactantItemAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.REACTANT,a)},getReactantAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.REACTANT,a)},getProductItemAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.PRODUCT,a)},getProductAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.PRODUCT,a)},getSubstanceItemAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.SUBSTANCE,a)},getSubstanceAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.SUBSTANCE,a)},getConditionItemAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.CONDITION,a)},indexOfReactantMap:function(a){return this.indexOfMap(Kekule.ReactionComponent.REACTANT,a)},indexOfProductMap:function(a){return this.indexOfMap(Kekule.ReactionComponent.PRODUCT,a)},indexOfSubstanceMap:function(a){return this.indexOfMap(Kekule.ReactionComponent.SUBSTANCE,a)},indexOfConditionMap:function(a){return this.indexOfMap(Kekule.ReactionComponent.CONDITION,a)},indexOfReactant:function(a,b){return this.indexOfItem(Kekule.ReactionComponent.REACTANT,a,b)},indexOfProduct:function(a,b){return this.indexOfItem(Kekule.ReactionComponent.PRODUCT,a,b)},indexOfSubstance:function(a,b){return this.indexOfItem(Kekule.ReactionComponent.SUBSTANCE,a,b)},indexOfCondition:function(a,b){return this.indexOfItem(Kekule.ReactionComponent.CONDITION,a,b)},appendReactantMap:function(a){return this.appendMap(Kekule.ReactionComponent.REACTANT,a)},appendProductMap:function(a){return this.appendMap(Kekule.ReactionComponent.PRODUCT,a)},appendSubstanceMap:function(a){return this.appendMap(Kekule.ReactionComponent.SUBSTANCE,a)},appendConditionMap:function(a){return this.appendMap(Kekule.ReactionComponent.CONDITION,a)},appendReactant:function(c,e,a,b){var d=b||{};if(a){d.amount=a}return this.appendItem(Kekule.ReactionComponent.REACTANT,c,e,d)},appendProduct:function(c,e,a,b){var d=b||{};if(a){d.amount=a}return this.appendItem(Kekule.ReactionComponent.PRODUCT,c,e,d)},appendSubstance:function(c,e,a,b){var d=b||{};if(a){d.amount=a}return this.appendItem(Kekule.ReactionComponent.SUBSTANCE,c,e,d)},appendCondition:function(b,c,a){return this.appendItem(Kekule.ReactionComponent.CONDITION,b,c,info)},removeReactantAt:function(a){return this.removeMapAt(Kekule.ReactionComponent.REACTANT,a)},removeProductAt:function(a){return this.removeMapAt(Kekule.ReactionComponent.PRODUCT,a)},removeSubstanceAt:function(a){return this.removeMapAt(Kekule.ReactionComponent.SUBSTANCE,a)},removeConditionAt:function(a){return this.removeMapAt(Kekule.ReactionComponent.CONDITION,a)},removeReactantMap:function(a){return this.removeMap(Kekule.ReactionComponent.REACTANT,a)},removeProductMap:function(a){return this.removeMap(Kekule.ReactionComponent.PRODUCT,a)},removeSubstanceMap:function(a){return this.removeMap(Kekule.ReactionComponent.SUBSTANCE,a)},removeConditionMap:function(a){return this.removeMap(Kekule.ReactionComponent.CONDITION,a)},removeReactant:function(a,b){return this.removeItem(Kekule.ReactionComponent.REACTANT,a,b)},removeProduct:function(a,b){return this.removeItem(Kekule.ReactionComponent.PRODUCT,a,b)},removeSubstance:function(a,b){return this.removeItem(Kekule.ReactionComponent.SUBSTANCE,a,b)},removeCondition:function(a,b){return this.removeItem(Kekule.ReactionComponent.CONDITION,a,b)},clearReactants:function(){return this.clearComponent(Kekule.ReactionComponent.REACTANT)},clearProducts:function(){return this.clearComponent(Kekule.ReactionComponent.PRODUCT)},clearSubstance:function(){return this.clearComponent(Kekule.ReactionComponent.SUBSTANCE)},clearConditions:function(){return this.clearComponent(Kekule.ReactionComponent.CONDITION)},clearAll:function(){this.clearProducts();this.clearProducts();this.clearSubstance();this.clearConditions()},getAllContainingConnectors:function(){var b=Kekule.ReactionComponent;var c=[b.REACTANT,b.PRODUCT,b.SUBSTANCE];var o=[];for(var g=0,d=c.length;g<d;++g){var h=c[g];for(var f=0,e=this.getComponentItemCount(h);f<e;++f){var n=this.getMapItemAt(h,f);if(n.getAllContainingConnectors){var m=n.getAllContainingConnectors();if(m&&m.length){o=o.concat(m)}}}}return o}});Kekule.ReactionList=Class.create(Kekule.ChemObjList,{CLASS_NAME:"Kekule.ReactionList",initialize:function($super,a){$super(a,Kekule.Reaction)}});(function(){var a=Kekule.ArrayUtils;Kekule.ChemStructureUtils={getConnectorLengthMedian:function(e,k,f){var g=[];for(var m=0,h=e.length;m<h;++m){var j=e[m];if(j&&j.getLength){var d=j.getLength(k,f);if(d){g.push(d)}}}if(h===0){return 1}if(h<=1){return g[0]}else{g.sort();var n=g.length;var o=(n%2)?g[(n+1)>>1]:(g[n>>1]+g[(n>>1)-1])/2;return o}},getChildStructureObjs:function(m,h){var e;if(m instanceof Kekule.CompositeMolecule){e=m.getSubMolecules().getAllObjs()}else{if(m instanceof Kekule.ChemStructureObjectGroup){e=m.getAllObjs()}else{if(m instanceof Kekule.ChemObjList){e=m.getItems()}else{if(m instanceof Kekule.ChemSpaceElement){e=m.getChildren().getItems()}else{if(m instanceof Kekule.ChemSpace){e=m.getChildren()}else{return[m]}}}}}e=[].concat(e);if(h){var g=[];for(var j=0,f=e.length;j<f;++j){var k=e[j];var d=Kekule.ChemStructureUtils.getChildStructureObjs(k,h);if(d.length<=1){Kekule.ArrayUtils.pushUnique(g,k)}else{Kekule.ArrayUtils.pushUnique(g,d)}}e=g}return e},getAllStructFragments:function(j,f){if(j instanceof Kekule.StructureFragment){return[j]}var h=Kekule.ChemStructureUtils.getChildStructureObjs(j,f);var d=[];for(var g=0,e=h.length;g<e;++g){if(h[g] instanceof Kekule.StructureFragment){Kekule.ArrayUtils.pushUnique(d,h[g])}}return d},getTotalStructFragment:function(g,e){var d=Kekule.ChemStructureUtils.getAllStructFragments(g,true);var f=d.length;if(f<=0){return null}else{if(f===1){return d[0]}else{return Kekule.ChemStructureUtils.mergeStructFragments(d,e)}}},getCascadeDeleteObjs:function(j){var n=[];var k=j.getLinkedConnectors?j.getLinkedConnectors():[];for(var g=0,d=k.length;g<d;++g){var e=k[g];if(e.getConnectedObjs().length<=2){Kekule.ArrayUtils.pushUnique(n,e);var m=Kekule.ChemStructureUtils.getCascadeDeleteObjs(e);Kekule.ArrayUtils.pushUnique(n,m)}}if(j instanceof Kekule.ChemStructureNode){}else{if(j instanceof Kekule.ChemStructureConnector){var h=j.getConnectedObjs();for(var g=0,d=h.length;g<d;++g){var f=h[g];if(f instanceof Kekule.ChemStructureNode){if(f.getLinkedConnectors().length<=1){Kekule.ArrayUtils.pushUnique(n,f)}}}}else{}}return n},moveChildBetweenStructFragment:function(h,d,e,g,f){return Kekule.StructureFragment.moveChildBetweenStructFragment(h,d,e,g,f)},_getCascadeConnectedNodesAndConnectors:function(g,e){var f=[];var d=[];var n=g.getConnectedObjs();for(var l=0,h=n.length;l<h;++l){var m=n[l];if(m!==g){if(e){m=e.findDirectChildOfObj(m)}if(m instanceof Kekule.ChemStructureNode){Kekule.ArrayUtils.pushUnique(d,m)}else{if(m instanceof Kekule.ChemStructureConnector){Kekule.ArrayUtils.pushUnique(f,m);var i=Kekule.ChemStructureUtils._getCascadeConnectedNodesAndConnectors(m);Kekule.ArrayUtils.pushUnique(f,i.connectors);Kekule.ArrayUtils.pushUnique(d,i.nodes)}}}}return{connectors:f,nodes:d}},mergeStructFragments:function(e,h){if(e.length<=1){return e[0]}else{var j=h||Kekule.Molecule;var d=new j();for(var g=0,f=e.length;g<f;++g){var k=e[g].clone();Kekule.ChemStructureUtils.moveChildBetweenStructFragment(k,d,k.getNodes(),k.getConnectors())}return d}},splitStructFragment:function(t){if(!t.hasCtab()){return[t]}var f=t.getNodes();if(f.length<=0){return[t]}var o=t.getConnectors();var u=[];var s=[f[0]];var k=[];var e=0;do{var j=s[e];var h=j.getLinkedConnectors();if(j.getCrossConnectors){h.concat(j.getCrossConnectors()||[])}Kekule.ArrayUtils.pushUnique(k,h);for(var r=0,m=h.length;r<m;++r){var q=Kekule.ChemStructureUtils._getCascadeConnectedNodesAndConnectors(h[r],t);Kekule.ArrayUtils.pushUnique(k,q.connectors);Kekule.ArrayUtils.pushUnique(s,q.nodes)}++e}while(e<s.length);u.push(t);var g=Kekule.ArrayUtils.exclude(f,s);var n=Kekule.ArrayUtils.exclude(o,k);if(g.length>0){var d=t.getClass();var p=new d();Kekule.ChemStructureUtils.moveChildBetweenStructFragment(t,p,g,n);var v=Kekule.ChemStructureUtils.splitStructFragment(p);u=u.concat(v)}return u},getAbsCoordVectorBetweenObjs:function(i,h,f,d){var g=i.getAbsCoordOfMode(f,d);var e=h.getAbsCoordOfMode(f,d);return Kekule.CoordUtils.substract(e,g)},_getRef2DCoordOfObj:function(e,d){var f=e.getAbsBaseCoord2D?e.getAbsBaseCoord2D(d):e.getAbsCoord2D?e.getAbsCoord2D(d):e.getCoord2D(d);return f},_getStandardizedLinkedObj2DRelCoords:function(q,k,f,n,d){var r=[];var o=Kekule.ChemStructureUtils._getRef2DCoordOfObj(q,f);var e=d?q.getLinkedObjs():q.getLinkedExposedObjs();if(n&&q.getAttachedMarkers){e=e.concat(q.getAttachedMarkers()||[])}if(k&&k.length){e=a.exclude(e,k)}for(var j=0,g=e.length;j<g;++j){var h=e[j];var m=Kekule.ChemStructureUtils._getRef2DCoordOfObj(h,f);var p=Kekule.CoordUtils.substract(m,o);p=Kekule.CoordUtils.standardize(p);r.push(p)}return r},_calcLinkedObj2DAnglesOfObj:function(o,k,e,m,d){var p=[];var h=Kekule.ChemStructureUtils._getStandardizedLinkedObj2DRelCoords(o,k,e,m,d);for(var j=0,g=h.length;j<g;++j){var n=h[j];if(n.x===0&&n.y===0){continue}var f=Math.atan2(n.y,n.x);if(f<0){f=Math.PI*2+f}p.push(f)}p.sort();return p},_getMostEmptyDirectionOfExistingAngles:function(j){var f=j.length;if(f===0){return 0}else{if(f===1){return -j[0]}else{var k=0;var h=0;for(var g=0;g<f;++g){var e=j[g];var d=j[(g+1)%f];var m=d-e;if(m<0){m+=Math.PI*2}if(m>k){k=m;h=g}}var n=j[h]+k/2;return n}}},getMostEmptyDirection2DAngleOfObj:function(e,h,f,k,g,i){var j=Kekule.ChemStructureUtils._calcLinkedObj2DAnglesOfObj(e,h,f,k,g);if(i){j=j.concat(i);j.sort()}var d=Kekule.ChemStructureUtils._getMostEmptyDirectionOfExistingAngles(j);return d}};Kekule.TokenAnalyzer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.TokenAnalyzer",initialize:function($super,d){$super();this.setSrcText(d)},initProperties:function(){this.defineProp("srcText",{dataType:DataType.STRING,setter:function(e){var d=e||"";this.setPropStoreFieldValue("srcText",d);this.setPropStoreFieldValue("srcLength",d.length);this.setCurrPos(0)}});this.defineProp("srcLength",{dataType:DataType.INT,setter:null,serializable:false});this.defineProp("currPos",{dataType:DataType.INT,serializable:false})},getCharType:function(d){return 0},isCharTypeMatched:function(e,d){return e===d},nextCharInfo:function(){var d=this.getCurrPos();if(d>=this.getSrcLength()){return null}else{var e=this.getSrcText().charAt(d);this.setCurrPos(d+1);return{"char":e,charType:this.getCharType(e)}}},nextTokenInfo:function(){var f=this.nextCharInfo();if(f){var e=f["char"];var g=f.charType;var d=this.nextCharInfo();while(d&&this.isCharTypeMatched(d.charType,f.charType)){e+=d["char"];f=d;d=this.nextCharInfo()}if(d){this.setCurrPos(this.getCurrPos()-1)}return{token:e,tokenType:g}}else{return null}},getAllTokenInfos:function(){var d=[];var e=this.nextTokenInfo();while(e){d.push(e);e=this.nextTokenInfo()}return d}});Kekule.ChemTextTypes={CT_ATOM_SYMBOL_LEADING:1,CT_ATOM_SYMBOL_FOLLOWING:2,CT_CHARGE_SYMBOL:3,CT_NUMBER:4,CT_BRACKET_LEADING:10,CT_BRACKET_TAILING:11,CT_SEPARATOR:20,CT_UNKNOWN:0};var b=Kekule.ChemTextTypes;Kekule.ChemTextAnalyzer=Class.create(Kekule.TokenAnalyzer,{CLASS_NAME:"Kekule.ChemTextAnalyzer",getCharType:function(d){if(d===" "){return b.CT_SEPARATOR}if(d>="0"&&d<="9"){return b.CT_NUMBER}else{if(["+","-"].indexOf(d)>=0){return b.CT_CHARGE_SYMBOL}else{if(["(","[","{"].indexOf(d)>=0){return b.CT_BRACKET_LEADING}else{if([")","]","}"].indexOf(d)>=0){return b.CT_BRACKET_TAILING}else{if(d>="A"&&d<="Z"){return b.CT_ATOM_SYMBOL_LEADING}else{if(d>="a"&&d<="z"){return b.CT_ATOM_SYMBOL_FOLLOWING}else{return b.CT_UNKNOWN}}}}}}},isCharTypeMatched:function(e,d){if(Kekule.ArrayUtils.intersect([b.CT_BRACKET_LEADING,b.CT_BRACKET_TAILING],[e,d]).length){return false}else{return(e===d&&d!==b.CT_ATOM_SYMBOL_LEADING)||(d===b.CT_ATOM_SYMBOL_LEADING&&e===b.CT_ATOM_SYMBOL_FOLLOWING)}}});Kekule.FormulaUtils={FORMULA_BRACKETS:[["(",")"],["[","]"],["{","}"]],FORMULA_BRACKET_TYPE_COUNT:3,textToFormula:function(r,m,e){var o=e||null;if(o){o.clear()}var z=new Kekule.ChemTextAnalyzer(r);try{var B=z.getAllTokenInfos();if(!o){o=new Kekule.MolecularFormula(m)}var s=B.length;if(s){var w,v,f=null,n;var g=o;v={};var C=function(){v={}};var A=function(){if(v&&v.obj){g.appendSection(v.obj,v.count,v.charge)}};for(var y=0;y<s;++y){var u=B[y];var D=u.tokenType;var h=u.token;var l=false;if(D===b.CT_BRACKET_LEADING){A();var k=new Kekule.MolecularFormula(m);k._parentFormula=g;g=k;C();l=true}else{if(D===b.CT_BRACKET_TAILING){A();C();v.obj=g;g=g._parentFormula;u.asSymbol=true;l=true}else{if([b.CT_ATOM_SYMBOL_LEADING,b.CT_ATOM_SYMBOL_FOLLOWING].indexOf(D)>=0){if(v.obj){A();C()}var d=v.massNum;if(!d){if(f&&!f.handled&&(f.tokenType===b.CT_NUMBER)){d=parseInt(f.token,10)||null}}var p=""+(d||"")+h;v.obj=Kekule.ChemStructureNodeFactory.createByLabel(p);u.asSymbol=true;l=true}else{if(D===b.CT_CHARGE_SYMBOL){n=(h==="+")?+1:-1;u.asCharge=true;if(f.tokenType===b.CT_NUMBER){var x;if(f.asCount){if(f.token.length>1){var q=f.token;x=q.substr(q.length-1);if(f.asCount){v.count=parseInt(q.substring(0,q.length-1),10)}}else{x=f.token;if(f.asCount){v.count=1}}}else{x=f.token;f.asChargeCount=true}n*=parseInt(x,10)}v.charge=n;l=true}else{if(D===b.CT_NUMBER){var j=parseInt(h,10);if(n&&f.tokenType===b.CT_CHARGE_SYMBOL&&f.asCharge){n*=j;v.charge=n;u.asChargeCount=true;l=true}else{if(v.obj&&f.asSymbol){v.count=j;u.asCount=true;l=true}else{if(!v.obj){v.massNum=j;l=true}else{}}}}}}}}u.handled=l;f=u}if(v&&v.obj){A()}}return o}finally{z.finalize()}},formulaToText:function(f,e,d){if(Kekule.ObjUtils.isUnset(e)){e=true}return c._convFormulaToText(f,false,e,d)},_convFormulaToText:function(n,t,p,g){var u="";var r=n.getSections();if(t){var e=n.getMaxNestedLevel()%c.FORMULA_BRACKET_TYPE_COUNT;var o=c.FORMULA_BRACKETS[e][0];var d=c.FORMULA_BRACKETS[e][1];u+=o}for(var j=0,f=r.length;j<f;++j){var h=r[j].obj;var m=n.getSectionCharge(r[j]);var q=null;if(h instanceof Kekule.MolecularFormula){q=c._convFormulaToText(h,true,false,false,g)}else{if(h.getLabel){var q=h.getLabel();if(h.getMassNumber&&h.getMassNumber()){q=(u?" ":"")+q}}}if(q){var k=false;if(r[j].count!=1){q+=r[j].count;k=true}if(p&&m){var s=c._convChargeToText(m,g);q+=(k?" ":"")+s}u+=q}}if(t){u+=d}if(p){var m=n.getCharge();if(m){var s=c._convChargeToText(m,g);u+=s}}return u},_convChargeToText:function(g,d){if(!g){return null}var h=(g>0)?"+":"-";var e=Math.abs(g);var f=h;if(e!=1){f=(d?Kekule.NumUtils.toDecimals(e,d):e.toString())+h}return f}};var c=Kekule.FormulaUtils;ClassEx.defineProp(Kekule.MolecularFormula,"text",{dataType:DataType.STRING,serializable:false,getter:function(){return c.formulaToText(this)},setter:function(d){c.textToFormula(d,this.getParent(),this)}})})();(function(){Kekule.Glyph={};Kekule.Glyph.Base=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Glyph.Base",initialize:function($super,c,a,b){$super(c);if(a){this.setCoord2D(a)}if(b){this.setCoord3D(b)}},initProperties:function(){},getAutoIdPrefix:function(){return"g"}});Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.Glyph.Base)})();(function(){Kekule.Glyph.PathGlyphNode=Class.create(Kekule.BaseStructureNode,{CLASS_NAME:"Kekule.Glyph.PathGlyphNode",initialize:function($super,d,a,b,c){$super(d);if(b){this.setCoord2D(b)}if(c){this.setCoord3D(c)}this.setNodeType(a||Kekule.Glyph.NodeType.LOCATION)},initProperties:function(){this.defineProp("nodeType",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLIC})}});Kekule.Glyph.NodeType={LOCATION:"location",HIDDEN:"hidden"};Kekule.Glyph.PathGlyphConnector=Class.create(Kekule.BaseStructureConnector,{CLASS_NAME:"Kekule.Glyph.PathGlyphConnector",initialize:function($super,c,a,b){$super(c,b);this.setPathType(a)},initProperties:function(){this.defineProp("pathType",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLISHED,enumSource:Kekule.Glyph.PathType});this.defineProp("pathParams",{dataType:DataType.HASH,scope:Class.PropertyScope.PUBLISHED,getter:function(){var a=this.getPropStoreFieldValue("pathParams");if(!a){a={};this.setPropStoreFieldValue("pathParams",a)}return a},setter:function(a){if(!a){this.setPropStoreFieldValue("pathParams",null)}else{this.setPropStoreFieldValue("pathParams",Object.extend({},a,true))}}})}});Kekule.Glyph.PathType={LINE:"L"};Kekule.Glyph.ArrowType={NONE:null,OPEN:"open",TRIANGLE:"triangle"};Kekule.Glyph.ArrowSide={BOTH:0,SINGLE:1,REVERSED:-1};Kekule.Glyph.PathGlyph=Class.create(Kekule.Glyph.Base,{CLASS_NAME:"Kekule.Glyph.PathGlyph",initialize:function($super,e,a,b,c,d){$super(e,c,d);this.createDefaultStructure(a||1,b||{})},doFinalize:function($super){if(this.hasCtab()){this.getCtab().finalize()}$super()},initProperties:function(){this.defineProp("ctab",{dataType:"Kekule.StructureConnectionTable",scope:Class.PropertyScope.PUBLIC,getter:function(a){if(!this.getPropStoreFieldValue("ctab")){if(a){this.createCtab()}}return this.getPropStoreFieldValue("ctab")},setter:function(b){var a=this.getPropStoreFieldValue("ctab");if(a){a.finalize();a=null}if(b){b.setPropValue("parent",this,true);b.setOwner(this.getOwner())}this.setPropStoreFieldValue("ctab",b)}});this.defineProp("nodes",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNodes():[]}});this.defineProp("connectors",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getConnectors():[]}})},createDefaultStructure:function(a,b){if(!a){a=1}var e={};var c=["lineGap","startArrowLength","startArrowWidth","endArrowLength","endArrowWidth"];for(var d in b){if(c.indexOf(d)>=0){e[d]=b[d]*a}else{e[d]=b[d]}}return this.doCreateDefaultStructure(a,e)},doCreateDefaultStructure:function(a,b){},getAutoIdPrefix:function(){return"p"},ownerChanged:function($super,a){if(this.hasCtab()){this.getCtab().setOwner(a)}$super(a)},_removeChildObj:function(b){if(this.hasCtab()){var a=this.getCtab();if(a===b){this.removeCtab()}else{if(a.hasChildObj(b)){a.removeChildObj(b)}}}},isEmpty:function(){return this.getCtab().isEmpty()},createCtab:function(){var a=new Kekule.StructureConnectionTable(this.getOwner(),this);this.setPropStoreFieldValue("ctab",a);a.addEventListener("propValueSet",function(b){if(b.propName=="nodes"){this.notifyPropSet(b.propName,b.propValue)}},this);a.setEnablePropValueSetEvent(true)},hasCtab:function(){return(!!this.getPropStoreFieldValue("ctab"))},getContainerBox:function($super,b,a){if(this.hasCtab()){return this.getCtab().getContainerBox(b,a)}else{return $super(b)}},getNodeById:function(a){return this.hasCtab()?this.getCtab().getNodeById(a):null},getConnectorById:function(a){return this.hasCtab()?this.getCtab().getConnectorById(a):null},getObjectById:function(b){var a=this.getNodeById(b);return a?a:this.getConnectorById(b)},getNodeCount:function(){return this.hasCtab()?this.getCtab().getNodeCount():0},getNodeAt:function(a){return this.hasCtab()?this.getCtab().getNodeAt(a):null},indexOfNode:function(a){return this.hasCtab()?this.getCtab().indexOfNode(a):-1},hasNode:function(b,a){return this.hasCtab()?the.getCtab().hasNode(b,a):null},appendNode:function(a){return this.doGetCtab(true).appendNode(a)},insertNodeAt:function(b,a){return this.doGetCtab(true).insertNodeAt(b,a)},removeNodeAt:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeNodeAt(b,a)},removeNode:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeNode(b,a)},replaceNode:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().replaceNode(b,a)},clearNodes:function(){if(this.hasCtab()){return this.getCtab().clearNodes()}},nodesHasCoord2D:function(a){if(!this.hasCtab()){return false}return this.getCtab().nodesHasCoord2D(a)},nodesHasCoord3D:function(a){if(!this.hasCtab()){return false}return this.getCtab().nodesHasCoord3D(a)},getConnectorCount:function(){return this.hasCtab()?this.getCtab().getConnectorCount():0},getConnectorAt:function(a){return this.hasCtab()?this.getCtab().getConnectorAt(a):null},indexOfConnector:function(a){return this.hasCtab()?this.getCtab().indexOfConnector(a):-1},hasConnector:function(a,b){return this.hasCtab()?this.getCtab().hasConnector(a,b):null},appendConnector:function(a){return this.doGetCtab(true).appendConnector(a)},insertConnectorAt:function(a,b){return this.doGetCtab(true).insertConnectorAt(a,b)},removeConnectorAt:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeConnectorAt(b,a)},removeConnector:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeConnector(b,a)},clearConnectors:function(){if(this.hasCtab()){return this.getCtab().clearConnectors()}},insertBefore:function(b,a){if(this.hasCtab()){return this.getCtab().insertBefore(b,a)}},_getObjsNeedToBeCascadeRemoved:function(b,a){if(this.hasCtab()){return this.getCtab()._getObjsNeedToBeCascadeRemoved(b,a)}else{return[]}},removeChildObj:function(c,b,a){if(this.hasCtab()){this.getCtab().removeChildObj(c,b,a)}},removeChild:function($super,a){return this.removeChildObj(a)||$super(a)},hasChildObj:function(a){if(this.hasCtab()){return this.getCtab().hasChildObj(a)}else{return false}},getNextSiblingOfChild:function(a){if(this.hasCtab()){return this.getCtab().getNextSiblingOfChild(a)}else{return null}},getChildCount:function(){if(this.hasCtab()){return this.getCtab().getChildCount()}else{return 0}},getChildAt:function(a){if(this.hasCtab()){return this.getCtab().getChildAt(a)}else{return null}},indexOfChild:function(a){if(this.hasCtab()){return this.getCtab().indexOfChild(a)}else{return -1}}})})();(function(){var a=Kekule.Glyph.NodeType;var b=Kekule.Glyph.PathType;Kekule.Glyph.StraightLine=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.StraightLine",initialize:function($super,g,c,d,e,f){$super(g,c,d,e,f)},doCreateDefaultStructure:function(i,c){var d=Kekule.CoordUtils;var g={x:0,y:0};var f={x:0,y:0,z:0};var h={x:i*(c.lineLength||1)};var k=new Kekule.Glyph.PathGlyphNode(null,null,g,f);var j=new Kekule.Glyph.PathGlyphNode(null,null,d.add(g,h),d.add(f,h));var e=new Kekule.Glyph.PathGlyphConnector(null,b.LINE,[k,j]);this._applyParamsToConnector(e,c);this.appendNode(k);this.appendNode(j);this.appendConnector(e)},_applyParamsToConnector:function(c,d){c.setPathParams(d)}});Kekule.Glyph.Polygon=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.Polygon",initialize:function($super,g,c,d,e,f){$super(g,c,d,e,f)},getRefLengthRatio:function(){return 1},doCreateDefaultStructure:function(h,w){var n=Kekule.CoordUtils;var e={x:0,y:0};var j={x:0,y:0,z:0};var p=w.nodeProps;var l=w.connectorProps;var o=h*(w.lineLength||1)*this.getRefLengthRatio();var u=w.edgeCount||3;var m=Math.PI*2/u;var k=(u%2)?0:-m/2;var f=k;var s,g;for(var t=0;t<u;++t){var v={x:o*Math.sin(f),y:o*Math.cos(f)};var q=new Kekule.Glyph.PathGlyphNode(null,null,n.add(e,v),n.add(j,v));if(p){q.setPropValues(p)}this.appendNode(q);if(t===0){s=q}if(g){var d=new Kekule.Glyph.PathGlyphConnector(null,b.LINE,[g,q]);if(l){d.setPropValues(l)}this._applyParamsToConnector(d,w);this.appendConnector(d)}g=q;f+=m}var d=new Kekule.Glyph.PathGlyphConnector(null,b.LINE,[q,s]);if(l){d.setPropValues(l)}this._applyParamsToConnector(d,w);this.appendConnector(d)},_applyParamsToConnector:function(c,d){c.setPathParams(d)}})})();(function(){var a=Kekule.Glyph.NodeType;var b=Kekule.Glyph.PathType;Kekule.Glyph.HeatSymbol=Class.create(Kekule.Glyph.Polygon,{CLASS_NAME:"Kekule.Glyph.HeatSymbol",initialize:function($super,g,c,d,e,f){$super(g,c,d,e,f);this.setRenderOption("strokeWidth",1.5)},getRefLengthRatio:function(){return 0.25},doCreateDefaultStructure:function($super,c,d){d.edgeCount=3;d.nodeProps=Object.extend(d.nodeProps||{},{interactMode:Kekule.ChemObjInteractMode.HIDDEN});d.connectorProps=Object.extend(d.connectorProps||{},{interactMode:Kekule.ChemObjInteractMode.HIDDEN});return $super(c,d)},_applyParamsToConnector:function($super,c,d){return $super(c,d)}});Kekule.Glyph.AddSymbol=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.AddSymbol",initialize:function($super,g,c,d,e,f){$super(g,c,d,e,f);this.setRenderOption("strokeWidth",1.5)},getRefLengthRatio:function(){return 0.5},doCreateDefaultStructure:function(s,c){var o={interactMode:Kekule.ChemObjInteractMode.HIDDEN};var k={interactMode:Kekule.ChemObjInteractMode.HIDDEN};var d=Kekule.CoordUtils;var q={x:0,y:0};var n={x:0,y:0,z:0};var e=s*this.getRefLengthRatio()*(c.lineLength||1)/2;var f=new Kekule.Glyph.PathGlyphNode(null,null,q,n);f.setPropValues(o);this.appendNode(f);var p=[{x:-e,y:0},{x:0,y:-e},{x:e,y:0},{x:0,y:e}];for(var m=0,j=p.length;m<j;++m){var r=p[m];var g=new Kekule.Glyph.PathGlyphNode(null,null,d.add(q,r),d.add(n,r));g.setPropValues(o);var h=new Kekule.Glyph.PathGlyphConnector(null,b.LINE,[f,g]);h.setPropValues(k);this._applyParamsToConnector(h,c);this.appendNode(g);this.appendConnector(h)}},_applyParamsToConnector:function(c,d){c.setPathParams(d)}})})();(function(){var a=Kekule.CoordMode;var b=Kekule.CoordUtils;Kekule.ContentBlock=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ContentBlock",initialize:function($super,e,c,d){$super(e);if(c){this.setCoord2D(c)}if(d){this.setCoord3D(d)}},initProperties:function(){this.defineProp("needRecalcSize",{dataType:DataType.BOOL})},getAutoIdPrefix:function(){return"b"},getCornerCoord1:function(d,c){return this.getCoordOfMode(d,c)},getCornerCoord2:function(e,c){var f=this.getCornerCoord1(e,c);var d=this.getSizeOfMode(e,c);return Kekule.CoordUtils.add(f,d)},getContainerBox:function($super,g,d){var h=this.getAbsCoordOfMode(g,d)||{};var e=this.getSizeOfMode(g,d)||{};if(g===Kekule.CoordMode.COORD3D){var f=Kekule.CoordUtils.add(h,this.getSizeOfMode(g,d)||{})}else{f={x:h.x+e.x,y:h.y-e.y}}var c=Kekule.BoxUtils.createBox(h,f);return c}});Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.ContentBlock);Kekule.ClassDefineUtils.addStandardSizeSupport(Kekule.ContentBlock);Kekule.TextBlock=Class.create(Kekule.ContentBlock,{CLASS_NAME:"Kekule.TextBlock",initialize:function($super,f,e,c,d){$super(f,c,d);this.setText(e||"")},initProperties:function(){this.defineProp("text",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"t"},doObjectChange:function($super,c){if(Kekule.ArrayUtils.intersect(["text","renderOptions"],c).length){this.setNeedRecalcSize(true)}}});Kekule.ImageBlock=Class.create(Kekule.ContentBlock,{CLASS_NAME:"Kekule.ImageBlock",initialize:function($super,f,e,c,d){$super(f,c,d);if(e){this.setSrc(e)}},initProperties:function(){this.defineProp("src",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLISHED,setter:function(c){if(c!==this.getSrc()){this.setPropStoreFieldValue("src",c);this._clearCacheImg()}}});this.defineProp("cacheImg",{dataType:DataType.OBJECT,scope:Class.PropertyScope.PUBLIC,serializable:false,setter:null,getter:function(){var c=this.getPropStoreFieldValue("cacheImg");if(!c&&Kekule.$document){c=this._createCacheImg(this.getSrc())}return c}})},getAutoIdPrefix:function(){return"g"},_createCacheImg:function(e){var c;var d=Kekule.$document;if(d&&d.body&&d.createElement){c=d.createElement("img");c.src=e}return c},_clearCacheImg:function(){var c=this.getPropStoreFieldValue("cacheImg");if(c){c.src="";try{delete c.width;delete c.height}catch(d){}}}})})();(function(){var a=Kekule.ArrayUtils;Kekule.ChemMarker={};ClassEx.extend(Kekule.ChemObject,{isAttachedMarker:function(){var b=this.getParent();return(b&&b.hasMarker(this))},notifyAttachedMarkersChanged:function(){this.notifyPropSet("attachedMarkers",this.getPropStoreFieldValue("attachedMarkers"))},_attachedMarkerAdded:function(b){},_attachedMarkerRemoved:function(b){},getMarkerCount:function(){var b=this.getPropStoreFieldValue("attachedMarkers");return b?b.length:0},getMarkerAt:function(b){var c=this.getPropStoreFieldValue("attachedMarkers");return c?c[b]:null},getMarkerOfType:function(f,e){for(var d=0,c=this.getMarkerCount();d<c;++d){var b=this.getMarkerAt(d);if((e&&b.getClass()===f)||(b instanceof f)){return b}}return null},getMarkersOfType:function(g,f){var b=[];for(var e=0,d=this.getMarkerCount();e<d;++e){var c=this.getMarkerAt(e);if((f&&c.getClass()===g)||(c instanceof g)){b.push(c)}}return b},fetchMarkerOfType:function(e,f,d,c){var b=this.getMarkerOfType(e,d);if(!b&&f){b=new e();b.beginUpdate();try{if(c){b.setPropValues(c)}this.appendMarker(b)}finally{b.endUpdate()}}return b},getUnplacedMarkers:function(f){var b=[];for(var e=0,d=this.getMarkerCount();e<d;++e){var c=this.getMarkerAt(e);if(!c.getCoordOfMode(f)){b.push(c)}}return b},indexOfMarker:function(b){var c=this.getPropStoreFieldValue("attachedMarkers");return c?c.indexOf(b):-1},hasMarker:function(b){return this.indexOfMarker(b)>=0},hasMarkerOfType:function(c,b){return !!this.getMarkerOfType(c,b)},appendMarker:function(c){var d=this.indexOfMarker(c);if(d>=0){return d}else{var b=this.getAttachedMarkers(true).push(c);c.beginUpdate();try{if(c.setOwner){c.setOwner(this.getOwner())}if(c.setParent){c.setParent(this)}this._attachedMarkerAdded(c)}finally{c.endUpdate()}this.notifyAttachedMarkersChanged();return b}},insertMarkerBefore:function(b,c){var d=this.indexOfMarker(c);return this.insertMarkerAt(b,d)},insertMarkerAt:function(b,c){var d=this.indexOfMarker(b);var e=this.getAttachedMarkers(true);if(Kekule.ObjUtils.isUnset(c)||(c<0)){c=e.length}if(d>=0){e.splice(d,1);e.splice(c,0,b)}else{e.splice(c,0,b);if(b.setOwner){b.setOwner(this.getOwner())}if(b.setParent){b.setParent(this)}this._attachedMarkerAdded(b)}this.notifyAttachedMarkersChanged();return c},setMarkerIndex:function(b,c){var d=this.indexOfMarker(b);if(d>=0){var e=this.getPropStoreFieldValue("attachedMarkers");e.splice(d,1);e.splice(c,0,b)}},removeMarkerAt:function(d){var c=this.getMarkerAt(d);if(c){var b=this.getAttachedMarkers(true).splice(d,1);if(c.setOwner){c.setOwner(null)}if(c.setParent){c.setParent(null)}this._attachedMarkerRemoved(c);this.notifyAttachedMarkersChanged();return b}},removeMarker:function(b){var c=this.indexOfMarker(b);if(c>=0){return this.removeMarkerAt(c)}},replaceMarker:function(b,c){var d=this.indexOfMarker(b);if(d<0){return this}else{this.removeMarkerAt(d);this.insertMarkerAt(c,d);return this}},clearMarkers:function(){var e=this.getPropStoreFieldValue("attachedMarkers");if(e){e=a.clone(e)}this.setPropStoreFieldValue("attachedMarkers",null);if(e){for(var d=0,c=e.length;d<c;++d){var b=e[d];if(b.setOwner){b.setOwner(null)}if(b.setParent){b.setParent(null)}this._attachedMarkerRemoved(b)}}this.notifyAttachedMarkersChanged();return this},autoSetMarker2DPos:function(b,f,c,d){if(this.hasMarker(b)){var e=Kekule.ChemStructureUtils.getMostEmptyDirection2DAngleOfObj(this,[b],c,true,false,d);var g={x:f*Math.cos(e),y:f*Math.sin(e)};b.setCoord2D(g)}},_updateAttachedMarkersOwner:function(b){if(!b){b=this.getOwner()}for(var e=0,d=this.getMarkerCount();e<d;++e){var c=this.getMarkerAt(e);if(c.setOwner){c.setOwner(b)}}},_updateAttachedMarkersParent:function(e){if(!e){e=this}for(var d=0,c=this.getMarkerCount();d<c;++d){var b=this.getMarkerAt(d);if(b.setParent){b.setParent(e)}}}});ClassEx.extendMethod(Kekule.ChemObject,"ownerChanged",function(c,b){c(b);this._updateAttachedMarkersOwner(b)});ClassEx.extendMethod(Kekule.ChemObject,"removeChild",function(c,d){var b=c(d);if(!b){b=this.removeMarker(d)||c(d)}return b});ClassEx.extendMethod(Kekule.ChemObject,"insertBefore",function(d,e,c){var b=d(e,c);if(b<0){if(c&&this.hasMarker(c)||e instanceof Kekule.ChemMarker.BaseMarker){b=this.insertMarkerBefore(e,c)}}return b});ClassEx.defineProp(Kekule.ChemObject,"attachedMarkers",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLISHED,getter:function(c){var b=this.getPropStoreFieldValue("attachedMarkers");if(!b&&c){b=[];this.setPropStoreFieldValue("attachedMarkers",b)}return b},setter:function(b){this.clearMarkers();this.setPropStoreFieldValue("attachedMarkers",b);this._updateAttachedMarkersOwner();this._updateAttachedMarkersParent()}})})();(function(){Kekule.ChemMarker.BaseMarker=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ChemMarker.BaseMarker",initialize:function a($super,d,b,c){$super(d,b,c)},getAutoIdPrefix:function(){return"marker"}});Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.ChemMarker.BaseMarker);Kekule.ChemMarker.UnbondedElectronSet=Class.create(Kekule.ChemMarker.BaseMarker,{CLASS_NAME:"Kekule.ChemMarker.UnbondedElectronSet",initProperties:function(){this.defineProp("electronCount",{dataType:DataType.VARIANT})},initPropValues:function($super){$super();this.setElectronCount(2)}});Kekule.ChemMarker.ChemPropertyMarker=Class.create(Kekule.ChemMarker.BaseMarker,{CLASS_NAME:"Kekule.ChemMarker.ChemPropertyMarker",initProperties:function(){this.defineProp("value",{dataType:DataType.VARIANT,serializable:false,getter:function(){var b;var d=this.getParent();var c=this.getPropertyName();if(d&&c){b=d.getPropValue(c);this.setPropStoreFieldValue("value",b)}else{b=this.getPropStoreFieldValue("value")}return b},setter:function(b){this.setPropStoreFieldValue("value",b);this.setParentPropValue(b)}})},initPropValues:function($super){$super()},setParentPropValue:function(c){var d=this.getParent();if(d){var b=this.getPropertyName();if(b&&d){d.setPropValue(b,c)}}return this},resetParentPropValue:function(){return this.setParentPropValue(undefined)},getPropertyName:function(){return null},beforAddingByEditor:function(c,b){if(c){var d=this.getPropStoreFieldValue("value");if(Kekule.ObjUtils.notUnset(d)){this.setParentPropValue(d)}}$super()},beforeRemovingByEditor:function(b){this.setPropStoreFieldValue("value",this.getValue());this.resetParentPropValue()}});Kekule.ChemMarker.Charge=Class.create(Kekule.ChemMarker.ChemPropertyMarker,{CLASS_NAME:"Kekule.ChemMarker.Charge",getPropertyName:function(){return"charge"}});Kekule.ChemMarker.Radical=Class.create(Kekule.ChemMarker.ChemPropertyMarker,{CLASS_NAME:"Kekule.ChemMarker.Radical",getPropertyName:function(){return"radical"}});ClassEx.extend(Kekule.ChemStructureNode,{fetchChargeMarker:function(c,b){return this.fetchMarkerOfType(Kekule.ChemMarker.Charge,c,false,b)},fetchRadicalMarker:function(c,b){return this.fetchMarkerOfType(Kekule.ChemMarker.Radical,c,false,b)}});ClassEx.defineProp(Kekule.AbstractAtom,"lonePairCount",{dataType:DataType.INT,scope:Class.PropertyScope.PUBLISHED,serializable:false,setter:null,getter:function(){var c=0;var e=this.getMarkersOfType(Kekule.ChemMarker.UnbondedElectronSet);for(var f=0,d=e.length;f<d;++f){var b=e[f];if(b.getElectronCount()===2){++c}}return c}});ClassEx.extendMethod(Kekule.AbstractAtom,"doCompare",function(h,g,e){var c=h(g,e);if(!c&&e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(e,"lonePair")||this._getComparisonOptionFlagValue(e,"unbondedElectron")){var f=function(p){var k=[];if(p.getMarkersOfType){var n=p.getMarkersOfType(Kekule.ChemMarker.UnbondedElectronSet);for(var o=0,m=n.length;o<m;++o){var j=n[o];k.push(j.getElectronCount())}}k.sort();return k};var d=f(this);var b=f(g);return Kekule.ArrayUtils.compare(d,b)}}return c})})();